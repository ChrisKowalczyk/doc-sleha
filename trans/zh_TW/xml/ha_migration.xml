<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE appendix PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<appendix xml:base="ha_migration.xml" id="app.ha.migration">
 <title>升級叢集和更新軟體套件</title>
 <abstract>
  <para>本章介紹兩種不同的方案：將叢集升級到另一個版本的 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> (主要版本或 Service Pack)，以及更新叢集節點上的個別套件。 </para>
 </abstract>
   
 <sect1 id="sec.ha.migration.terminology">
  <title>術語</title>
  <para>下面將介紹本章中使用的最重要的術語定義：</para>
  
  <variablelist>
   <varlistentry>
    <term>主要版本</term>
    <term>廣泛使用 (GA) 版本</term>
    <listitem>
     <para> SUSE Linux Enterprise (或任何軟體產品) 的主要版本是一個新版本，該版本中引入了新功能及工具，去除了以前取代的元件並提供了不可反向相容的變更。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Service Pack (SP)</term>
    <listitem>
     <para> 將多個修補程式合併為一種易於安裝或部署的形式。Service Pack 都指定了編號，通常包含程式的安全性修正、更新、升級或增強。 </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>更新</term>
    <listitem>
     <para> 安裝套件的較新<emphasis>次要</emphasis>版本。 </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>升級</term>
    <listitem>
     <para> 安裝套件或套裝作業系統的較新<emphasis>主要</emphasis>版本，會引入<emphasis>新功能</emphasis>。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 
 <sect1 id="sec.ha.migration.upgrade">
  <title>將叢集升級到產品的最新版本</title>
  <para>支援哪種升級路徑以及如何執行升級，視執行叢集的目前產品版本以及您要移轉到的目標版本而定。如需與此相關的一般資訊，請參閱《<citetitle>SUSE Linux Enterprise Server 12 部署指南</citetitle>》中的「<citetitle>更新 SUSE Linux Enterprise</citetitle>」一章。此文件位於 <ulink url="http://www.suse.com/documentation/"/>。 </para>
 

  <sect2 id="sec.ha.migration.upgrade.sle12">
   <title>從 SLE HA 11 SP3 升級到 SLE HA 12</title>

   <para>若要成功升級到 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12，您的叢集需要執行最新版本的 SUSE Linux Enterprise Server 和 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> (11 SP3)。如果您的叢集仍然以舊版產品為基礎，請先升級到 SUSE Linux Enterprise Server 和 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 11 SP3。如需相關資訊，請參閱《<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> <emphasis>11</emphasis> <citetitle>管理指南</citetitle>》中的「<citetitle>將叢集升級到產品的最新版本</citetitle>」一章。此文件位於 <ulink url="http://www.suse.com/documentation/"/>。 </para>

   <para>由於 High Availability Extension 12 的各個元件 (例如 <filename>/etc/corosync/corosync.conf</filename>，以及 OCFS2 的磁碟格式) 已發生重要變更，此方案不支援<literal>滾存升級</literal>。所有叢集節點都必須處於離線狀態，並且需要依照<xref linkend="pro.ha.migration.sle12"/>所述移轉整個叢集。不支援在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 11/<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12 上執行混合叢集。</para>


   <procedure id="pro.ha.migration.sle12">
    <title>將叢集升級到 SLE HA 12</title>
    <important>
     <title>升級前的必要準備</title>
     <itemizedlist mark="bullet" spacing="normal">
      <listitem>
       <para>確保您的系統備份是最新版本且可還原。</para>
      </listitem>
      <listitem>
       <para>在線上環境中執行升級程序前，請先在叢集設定的臨時例項上測試該程序。</para>
       <para>這樣，您便可以預估維護期所需的時間範圍。這也有助於偵測和解決可能會出現的任何非預期問題。</para>
      </listitem>
     </itemizedlist>
    </important>
    <para>針對每個叢集節點執行下列步驟：</para>
    <step performance="required">
     <para>登入每個叢集節點，並使用以下指令停止叢集堆疊：</para>
     <screen><prompt role="root">root # </prompt> rcopenais stop</screen>
    </step>
    <step performance="required">
     <para>對於每個叢集節點，執行從 SUSE Linux Enterprise Server 11 SP3 到 SUSE Linux Enterprise Server 12 的升級，以及從 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 11 SP3 到 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12 的升級。如果您要使用地理叢集，請依照《<citetitle>Geo Clustering for SUSE Linux Enterprise High Availability Extension Quick Start</citetitle>》(Geo Clustering for SUSE Linux Enterprise High Availability Extension 快速入門) 中所述安裝相應的附加產品。如需如何升級產品的資訊，請參閱《<citetitle>SUSE Linux Enterprise Server 12 部署指南</citetitle>》中的「<citetitle>更新 SUSE Linux Enterprise</citetitle>」一章。此文件位於 <ulink url="http://www.suse.com/documentation/"/>。</para>
    </step>
    <step performance="required">
     <para>完成升級程序後，將裝有 SUSE Linux Enterprise Server 12 和 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12 版本的每個節點重新開機。</para>
    </step>
    <step performance="required">
     <para>如果在叢集設定中使用了 OCFS2，請執行以下指令更新裝置上的結構：</para>
     <screen><prompt role="root">root # </prompt> tunefs.ocfs2 --update-cluster-stack <replaceable>PATH_TO_DEVICE</replaceable></screen>
     <para>該指令會向磁碟新增附加參數，<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12 隨附的 OCFS2 更新版本需要這些參數。</para>
    </step>
    <step performance="required">
     <para>若要更新 Corosync 版本 2 的 <filename>/etc/corosync/corosync.conf</filename>：</para>
     <substeps performance="required">
      <step performance="required">
       <para>登入某個節點，然後啟動 YaST 叢集模組。</para>
      </step>
      <step performance="required">
       <para>切換到<guimenu>通訊通道</guimenu>類別，並輸入以下新參數的值：<guimenu>叢集名稱</guimenu>和<guimenu>預期投票數</guimenu>。如需詳細資料，請參閱<xref linkend="pro.ha.installation.setup.channel1"/>。</para>
       <para>如果 YaST 偵測到對 Corosync 版本 2 無效或缺失的任何其他選項，它會提示您變更這些選項。 </para>
       
      </step>
      <step performance="required">
       <para>確認在 YaST 中所做的變更，以更新 <filename>/etc/corosync/corosync.conf</filename>。</para>
      </step>
      <step performance="required">
       <para>如果為叢集設定了 Csync2，請使用以下指令將更新的 Corosync 組態推入至其於叢集節點：</para>
       <screen><prompt role="root">root # </prompt><command>csync2</command> <option>-xv</option></screen>
       <para>如需 Csync2 的詳細資料，請參閱<xref linkend="sec.ha.installation.setup.csync2"/>。 </para>
       <para>或者，也可以透過將 <filename>/etc/corosync/corosync.conf</filename> 手動複製到所有叢集節點的方式來同步化更新的 Corosync 組態。</para>
      </step>
     </substeps>
    </step>
    <step performance="required">
     <para>登入每個節點，並使用以下指令啟動叢集堆疊：</para>
     <screen><prompt role="root">root # </prompt> systemctl start pacemaker.service</screen>
    </step>
    <step performance="required">
     <para> 使用 <command>crm status</command> 或 Hawk 檢查叢集狀態。</para>
    </step>
   </procedure>
   
   <para>如果您有一個現有的地理叢集設定，並想將它升級為執行 High Availability Extension 12 和 Geo Clustering for SUSE Linux Enterprise High Availability Extension 12，請參閱《Geo Clustering for SUSE Linux Enterprise High Availability Extension <citetitle>Quick Start</citetitle>》(Geo Clustering for SUSE Linux Enterprise High Availability Extension 快速入門) 中的其他指示。此文件位於 <ulink url="http://www.suse.com/documentation/"/>。請參閱「<citetitle>Upgrading from SLE HA 11 SP3 to SLE HA 12</citetitle>」(從 SLE HA 11 SP3 升級到 SLE HA 12) 一節。 </para>

   <note>
    <title>升級後回復</title>
    <para>
      執行了升級到產品版本 12 的程序之後，將<emphasis>不</emphasis>支援還原到產品版本 11。 </para>
   </note>
  </sect2>
 </sect1>


 <sect1 id="sec.ha.update">
  <title>更新叢集節點上的軟體套件</title>

  <para>在節點上安裝任何套件更新之前，請檢查以下幾點： </para>
  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>更新是否會影響屬於 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 或 Geo Clustering for SUSE Linux Enterprise High Availability Extension 附加產品的任何套件？如果會影響，請在開始軟體更新前先在節點上停止叢集堆疊。</para>
    <screen><prompt role="root">root # </prompt> systemctl stop pacemaker.service</screen>
   </listitem>
   <listitem>
    <para>更新套件是否需要重新開機？如果需要，請在開始軟體更新前先在節點上停止叢集堆疊：</para>
    <screen><prompt role="root">root # </prompt> systemctl stop pacemaker.service</screen>
   </listitem>
  </itemizedlist>
  <para>如果不屬於以上任一種情況，則不需要停止叢集堆疊。在此情況下，請在開始軟體更新前將叢集置於維護模式：</para>
  <screen><prompt role="root">root # </prompt><command>crm</command> configure property maintenance-mode=true</screen>
  <para>如需維護模式的詳細資料，請參閱<xref linkend="sec.ha.config.basics.maint.mode"/>。</para>

  <warning>
   <title>在更新期間處於使用中狀態的叢集堆疊</title>
   <para> 如果某個節點上的叢集資源管理員在軟體更新期間處於使用中狀態，可能會導致出現不可預知的結果，例如圍籬區隔使用中的節點。 </para>
  </warning>

  <para>成功安裝更新後，請將叢集解除維護模式：</para>
  <screen><prompt role="root">root # </prompt><command>crm</command> configure property maintenance-mode=true</screen>
  <para>或者使用以下指令在相應節點上重新啟動叢集堆疊：</para>
  <screen><prompt role="root">root # </prompt> systemctl start pacemaker.service</screen>
</sect1>
 
  
 <sect1 id="sec.ha.migration.more">
  <title>更多資訊</title>

  <para>
   如需所升級產品目標版本的任何變更及新功能的詳細資訊，請參閱其版本說明，這些文件可從 <ulink url="https://www.suse.com/releasenotes/"/> 取得。
  </para>
 </sect1>
</appendix>
