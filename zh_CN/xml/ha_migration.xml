<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE appendix PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<appendix xml:base="ha_migration.xml" id="app.ha.migration">
 <title>升级群集和更新软件包</title>
 <abstract>
  <para>本章介绍两种不同方案：将群集升级为 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 的另一个版本（主要版本或服务包），以及更新群集节点上的单个包。 </para>
 </abstract>
   
 <sect1 id="sec.ha.migration.terminology">
  <title>术语</title>
  <para>下面介绍本章中使用的最重要术语的定义：</para>
  
  <variablelist>
   <varlistentry>
    <term>主要版本</term>
    <term>正式发布 (GA) 版本</term>
    <listitem>
     <para> SUSE Linux Enterprise（或任何软件产品）的主要版本是一个新版本，其中会引入一些新功能和工具，去除之前弃用的组件，并进行一些不向后兼容的更改。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>服务包 (SP)</term>
    <listitem>
     <para> 将几个增补程序合并到便于安装或部署的一个组织体中。服务包是有编号的并通常包含安全性修复、更新、升级或程序增强。 </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>更新</term>
    <listitem>
     <para> 安装包的更新<emphasis>次要</emphasis>版本。 </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>升级</term>
    <listitem>
     <para> 安装包或分发包的更新<emphasis>主要</emphasis>版本，引入<emphasis>新功能</emphasis>。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 
 <sect1 id="sec.ha.migration.upgrade">
  <title>将群集升级到最新产品版本</title>
  <para>至于支持哪种升级路径以及如何执行升级，取决于运行群集的当前产品版本，以及您要迁移到的目标版本。有关一般信息，请参见《<citetitle>SUSE Linux Enterprise Server 12 部署指南</citetitle>》中的“<citetitle>更新 SUSE Linux Enterprise</citetitle>”一章。可通过 <ulink url="http://www.suse.com/documentation/"/> 获得。 </para>
 

  <sect2 id="sec.ha.migration.upgrade.sle12">
   <title>从 SLE HA 11 SP3 升级到 SLE HA 12</title>

   <para>要成功升级到 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12，您的群集需要运行最新版本的 SUSE Linux Enterprise Server 和 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> (11 SP3)。如果您的群集仍然基于较旧的产品版本，请先升级到 SUSE Linux Enterprise Server 和 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 11 SP3。可以在《<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> <emphasis>11</emphasis> <citetitle>管理指南</citetitle>》的“<citetitle>将群集升级到最新产品版本</citetitle>”中找到相关信息。可通过 <ulink url="http://www.suse.com/documentation/"/> 获得。 </para>

   <para>由于 High Availability Extension 12 的各个组件（例如 <filename>/etc/corosync/corosync.conf</filename>，以及 OCFS2 的磁盘格式）已发生重大更改，此方案不支持执行<literal>滚动升级</literal>。必须将所有群集节点脱机，并根据<xref linkend="pro.ha.migration.sle12"/>中所述迁移整个群集。不支持在 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 11/<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12 上运行混合群集。</para>


   <procedure id="pro.ha.migration.sle12">
    <title>将群集升级到 SLE HA 12</title>
    <important>
     <title>升级前必须满足的先决条件</title>
     <itemizedlist mark="bullet" spacing="normal">
      <listitem>
       <para>确保系统备份为最新的且可恢复。</para>
      </listitem>
      <listitem>
       <para>请先在群集设置的临时实例上测试升级过程，然后再在生产环境中执行该过程。</para>
       <para>这样，您便可以估算出维护期所需的时间段。这还有助于检测和解决可能会出现的任何意外问题。</para>
      </listitem>
     </itemizedlist>
    </important>
    <para>针对每个群集节点执行以下步骤：</para>
    <step performance="required">
     <para>登录到每个群集节点，并使用以下命令停止群集堆栈：</para>
     <screen><prompt role="root">root # </prompt> rcopenais stop</screen>
    </step>
    <step performance="required">
     <para>对于每个群集节点，执行从 SUSE Linux Enterprise Server 11 SP3 到 SUSE Linux Enterprise Server 12 的升级，以及从 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 11 SP3 到 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12 的升级。如果您要使用地域群集，请根据《<citetitle>Geo Clustering for SUSE Linux Enterprise High Availability Extension Quick Start</citetitle>》（Geo Clustering for SUSE Linux Enterprise High Availability Extension 快速入门）中所述安装相应的外接式附件产品。有关如何升级产品的信息，请参见《<citetitle>SUSE Linux Enterprise Server 12 部署指南</citetitle>》中的“<citetitle>更新 SUSE Linux Enterprise</citetitle>”一章。可通过 <ulink url="http://www.suse.com/documentation/"/> 获得。</para>
    </step>
    <step performance="required">
     <para>完成升级过程后，重引导装有 SUSE Linux Enterprise Server 12 和 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12 的每个节点。</para>
    </step>
    <step performance="required">
     <para>如果在群集设置中使用了 OCFS2，请执行以下命令以更新设备上的结构：</para>
     <screen><prompt role="root">root # </prompt> tunefs.ocfs2 --update-cluster-stack <replaceable>PATH_TO_DEVICE</replaceable></screen>
     <para>该命令会向磁盘添加附加的参数，<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12 随附的 OCFS2 更新版本需要这些参数。</para>
    </step>
    <step performance="required">
     <para>要更新 Corosync 2 的 <filename>/etc/corosync/corosync.conf</filename>，请执行以下操作：</para>
     <substeps performance="required">
      <step performance="required">
       <para>登录到某个节点，然后启动 YaST 群集模块。</para>
      </step>
      <step performance="required">
       <para>切换到<guimenu>通讯通道</guimenu>类别并输入以下新参数的值：<guimenu>群集名称</guimenu>和<guimenu>预期投票数</guimenu>。有关细节，请参见<xref linkend="pro.ha.installation.setup.channel1"/>。</para>
       <para>如果 YaST 检测到对 Corosync 2 无效或缺失的任何其他选项，它会提示您进行更改。 </para>
       
      </step>
      <step performance="required">
       <para>确认在 YaST 中所做的更改以更新 <filename>/etc/corosync/corosync.conf</filename>。</para>
      </step>
      <step performance="required">
       <para>如果为群集配置了 Csync2，请使用以下命令将更新的 Corosync 配置推送到其他群集节点：</para>
       <screen><prompt role="root">root # </prompt><command>csync2</command> <option>-xv</option></screen>
       <para>有关 Csync2 的细节，请参见<xref linkend="sec.ha.installation.setup.csync2"/>。 </para>
       <para>或者，也可以通过将 <filename>/etc/corosync/corosync.conf</filename> 手动复制到所有群集节点，来同步更新的 Corosync 配置。</para>
      </step>
     </substeps>
    </step>
    <step performance="required">
     <para>登录到每个节点，并使用以下命令启动群集堆栈：</para>
     <screen><prompt role="root">root # </prompt> systemctl start pacemaker.service</screen>
    </step>
    <step performance="required">
     <para> 使用 <command>crm status</command> 或 Hawk 检查群集状态。</para>
    </step>
   </procedure>
   
   <para>如果存在现有的地域群集设置而想要升级它以运行 High Availability Extension 12 和 Geo Clustering for SUSE Linux Enterprise High Availability Extension 12，请参见《<citetitle>Quick Start</citetitle> for Geo Clustering for SUSE Linux Enterprise High Availability Extension》（Geo Clustering for SUSE Linux Enterprise High Availability Extension 快速入门）中的附加说明。可通过 <ulink url="http://www.suse.com/documentation/"/> 获得。参见“<citetitle>从 SLE HA 11 SP3 升级到 SLE HA 12</citetitle>”一节。 </para>

   <note>
    <title>升级后还原</title>
    <para>
      完成到产品版本 12 的升级过程后，<emphasis>不</emphasis>支持再还原到产品版本 11。 </para>
   </note>
  </sect2>
 </sect1>


 <sect1 id="sec.ha.update">
  <title>更新群集节点上的软件包</title>

  <para>在节点上安装任何包更新之前，请先确认以下问题： </para>
  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>这种更新是否会影响属于 <phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 或 Geo Clustering for SUSE Linux Enterprise High Availability Extension 外接式附件的任何包？如果是，请先在节点上停止群集堆栈，然后再开始软件更新。</para>
    <screen><prompt role="root">root # </prompt> systemctl stop pacemaker.service</screen>
   </listitem>
   <listitem>
    <para>包更新操作是否需要重引导计算机？如果是，请先在节点上停止群集堆栈，然后再开始软件更新：</para>
    <screen><prompt role="root">root # </prompt> systemctl stop pacemaker.service</screen>
   </listitem>
  </itemizedlist>
  <para>如果不属于上述任何一种情况，则不需要停止群集堆栈。在这种情况下，请将群集置于维护模式，然后开始软件更新：</para>
  <screen><prompt role="root">root # </prompt><command>crm</command> configure property maintenance-mode=true</screen>
  <para>有关维护模式的更多细节，请参见<xref linkend="sec.ha.config.basics.maint.mode"/>。</para>

  <warning>
   <title>在更新期间处于活动状态的群集堆栈</title>
   <para> 如果在软件更新期间，群集资源管理器所在节点处于活动状态，可能会导致不可预料的结果，例如活动的节点被屏蔽。 </para>
  </warning>

  <para>成功安装更新后，请解除群集的维护模式：</para>
  <screen><prompt role="root">root # </prompt><command>crm</command> configure property maintenance-mode=true</screen>
  <para>或者使用以下命令在相应节点上重启动群集堆栈：</para>
  <screen><prompt role="root">root # </prompt> systemctl start pacemaker.service</screen>
</sect1>
 
  
 <sect1 id="sec.ha.migration.more">
  <title>更多信息</title>

  <para>
   关您要升级到的产品的任何更改和新功能的详细信息，请参见其发行说明，所在网址为 <ulink url="https://www.suse.com/releasenotes/"/>。
  </para>
 </sect1>
</appendix>
