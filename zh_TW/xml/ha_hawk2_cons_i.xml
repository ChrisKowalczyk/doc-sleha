<?xml version="1.0" encoding="UTF-8"?>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" xml:base="ha_hawk2_cons_i.xml" version="5.0" xml:id="sec.conf.hawk2.cons">
 
  <title>設定條件約束</title>
  
    <info>
   <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
    <dm:maintainer/>
    <dm:status>編輯</dm:status>
    <dm:deadline/>
    <dm:priority/>
    <dm:translation>yes</dm:translation>
    <dm:languages/>
    <dm:release/>
    <dm:repository/>
   </dm:docmanager>
  </info>
  
  <para>
   設定所有資源後，需要指定叢集應如何正確處理這些資源。資源條件約束可讓您指定資源可在哪些叢集節點上執行，載入資源的順序以及特定資源所依賴的其他資源。
  </para>
  <para>
   如需可用條件約束類型的綜覽，請參閱<xref linkend="sec.ha.config.basics.constraints.types"/>。定義條件約束時，還需要指定分數。如需叢集中分數及其含義的詳細資訊，請參閱<xref linkend="sec.ha.config.basics.constraints.scores"/>。
  </para>
 
  <sect2 xml:id="sec.conf.hawk2.cons.loc">
   <title>新增位置條件約束</title>

   <para>位置條件約束決定了資源在哪些節點上可以執行、優先執行或禁止執行。舉例而言，位置條件約束可以設為與特定資料庫相關的所有資源都在同一個節點上執行。</para>
   <procedure xml:id="pro.hawk2.constraints.location">
    <title>新增位置條件約束</title>
    <para>
     <remark>taroth 2015-12-02: todo for next release: explain advanced configuration (via
      rules)</remark>
    </para>
    <step>
     <para>登入 Hawk2︰</para>
     <screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
    </step>
    <step>
     <para>從左側導覽列中選取<menuchoice> <guimenu>組態</guimenu> <guimenu>新增條件約束</guimenu> <guimenu>位置</guimenu> </menuchoice>。</para>
    </step>
    <step>
     <para> 輸入唯一的<guimenu>條件約束 ID</guimenu>。 </para>
    </step>
    <step xml:id="step.hawk2.loc.rsc">
     <para>從<guimenu>資源</guimenu>清單中選取要為之定義條件約束的一個或多個資源。</para>
    </step>
    <step>
     <para> 輸入<guimenu>分數</guimenu>。分數表示您要指定給此資源條件約束的值。正值表示資源可以在您下一步中指定的<guimenu>節點</guimenu>上執行。負值表示資源不應在該節點上執行。系統會先套用分數較高的條件約束，然後再套用分數較低的條件約束。</para>
     <para>有些常用的值也可以透過下拉式方塊設定︰</para>
     <itemizedlist>
      <listitem>
       <para>若要強制資源在節點上執行，按一下箭頭圖示並選取<literal>永遠</literal>。這會將分數設為 <literal>INFINITY</literal>。</para>
      </listitem>
      <listitem>
       <para>若要杜絕資源在節點上執行，按一下箭頭圖示並選取<literal>永不</literal>。這會將分數設為 <literal>-INFINITY</literal>，表示禁止資源在節點上執行。</para>
      </listitem>
      <listitem>
       <para>若要將分數設為 <literal>0</literal>，按一下箭頭圖示並選取<literal>建議</literal>。此舉會從根本上停用條件約束。如果您想設定資源發現，又不想對資源進行條件約束，即可採用這個辦法。</para>
      </listitem>
     </itemizedlist>
    </step>
    <step>
     <para>選取一個<guimenu>節點</guimenu>。</para>
    </step>
    <step>
     <para>按一下<guimenu>建立</guimenu>完成組態。螢幕頂部的訊息會顯示動作是否成功。</para>
    </step>
   </procedure>

   <figure pgwide="0">
    <title>Hawk2—位置條件約束</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="hawk2-loc-constraint.png" width="100%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="hawk2-loc-constraint.png" width="100%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
  </sect2>
  <sect2 xml:id="sec.conf.hawk2.cons.col">
   <title>新增並存條件約束</title>
   <para>並存條件約束會告訴叢集哪些資源可以或不可以同時在節點上執行。</para>
   <procedure xml:id="pro.hawk2.constraints.colocation">
    <title>新增並存條件約束</title>
    <step>
     <para>登入 Hawk2︰</para>
     <screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
    </step>
    <step>
     <para>從左側導覽列中選取<menuchoice> <guimenu>組態</guimenu> <guimenu>新增條件約束</guimenu> <guimenu>並存</guimenu> </menuchoice>。</para>
    </step>
    <step>
     <para> 輸入唯一的<guimenu>條件約束 ID</guimenu>。 </para>
    </step>
    <step>
     <para> 輸入<guimenu>分數</guimenu>。分數決定了資源之間的位置關係。正值表示資源應該在同一個節點上執行。負值表示資源不應該在同一個節點上執行。該分數會結合其他因素來決定將資源配置於何處。 </para>
     <para>有些常用的值也可以透過下拉式方塊設定︰</para>
     <itemizedlist>
      <listitem>
       <para>若要強制資源在同一個節點上執行，按一下箭頭圖示並選取<literal>永遠</literal>。這會將分數設為 <literal>INFINITY</literal>。</para>
      </listitem>
      <listitem>
       <para>若要杜絕資源在同一個節點上執行，按一下箭頭圖示並選取<literal>永不</literal>。這會將分數設為 <literal>-INFINITY</literal>，表示禁止資源在同一個節點上執行。</para>
      </listitem>
     </itemizedlist>
    </step>
    <step>
     <para> 定義資源的條件約束︰ </para>
     <substeps performance="required">
      <step xml:id="step.hawk2.col.rsc">
       <para>從<guimenu>資源</guimenu>類別的下拉式方塊中選取一個資源 (或範本)，然後按一下清單旁邊的加號圖示。</para>
       <para>資源隨即新增完畢，下方會顯示新的空白下拉式方塊。</para>
      </step>
      <step>
       <para>重複此步驟以新增更多資源。</para>
       <para>由於並存條件約束定義的是不同資源之間的相依性，因此您至少需要有兩個資源。 </para>
       <para>由於最頂端的資源依賴於下一個資源 (下面的資源依此類推)，叢集首先會決定向哪個位置放置最後一個資源，然後根據該決定放置依賴資源。若無法符合條件約束要求，叢集可能會決定不允許執行相依資源。</para>
      </step>
      <step>
       <para>若要交換共存條件約束中不同資源的順序，按一下其中一個資源的向上箭頭圖示，將該資源換至輸入項的上方。 </para>
      </step>
     </substeps>
    </step>
    <step>
     <para> 需要時可以為每個資源指定更多參數 (例如 <literal>Started</literal>、<literal>Stopped</literal>、<literal>Master</literal>、<literal>Slave</literal>、<literal>Promote</literal> 和 <literal>Demote</literal>)︰按一下資源旁邊的空白下拉式方塊並選取所要的項目。</para>
    </step>
    <step>
     <para>按一下<guimenu>建立</guimenu>完成組態。螢幕頂部的訊息會顯示動作是否成功。</para>
    </step>
   </procedure>

   <figure pgwide="0">
    <title>Hawk2—並存條件約束</title>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="hawk2-col-constraint.png" width="100%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="hawk2-col-constraint.png" width="100%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </figure>
  </sect2>
   
  <sect2 xml:id="sec.conf.hawk2.cons.order">
   <title>新增順序條件約束</title>
   <para>
    順序條件約束定義了啟動和停止資源的順序。
   </para>
  <procedure xml:id="pro.hawk2.constraints.order">
   <title>新增順序條件約束</title>
  
   <step>
    <para>登入 Hawk2︰</para>
    <screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
   </step>
   <step>
    <para>從左側導覽列中選取<menuchoice> <guimenu>組態</guimenu> <guimenu>新增條件約束</guimenu> <guimenu>順序</guimenu> </menuchoice>。</para>
   </step>
   <step>
    <para> 輸入唯一的<guimenu>條件約束 ID</guimenu>。 </para>
   </step>
   <step>
    <para> 輸入<guimenu>分數</guimenu>。若分數大於零，則強制執行順序條件約束，否則只是選擇性執行。 </para>
    <para>有些常用的值也可以透過下拉式方塊設定︰</para>
    
    <itemizedlist>
     <listitem>
      <para>若要設為強制執行順序條件約束，按一下箭頭圖示並選取<literal>強制</literal>。</para>
     </listitem>
     <listitem>
      <para>若要只是選擇性執行順序條件約束，按一下箭頭圖示並選取<literal>選擇性</literal>。 </para>
     </listitem>
     <listitem>
      <para><literal>序列化</literal>︰要確保對資源杜絕兩對停止/啟動動作同時發生的情況，按一下箭頭圖示並選取<literal>序列化</literal>。這樣可以確保只有在一個資源完全啟動後，系統才能啟動其他資源。特別是對於在啟動期間會對主機產生大量負載的資源，通常會使用此方法。</para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para> 對於順序條件約束通常可以啟用<guimenu>對稱</guimenu>選項。這會指定資源停止時使用相反順序。 </para>
   </step>
   <step>
    <para> 定義資源的條件約束︰ </para>
    <substeps performance="required">
     <step xml:id="step.hawk2.order.rsc">
      <para>從<guimenu>資源</guimenu>類別的下拉式方塊中選取一個資源 (或範本)，然後按一下清單旁邊的加號圖示。</para>
      <para>資源隨即新增完畢，下方會顯示新的空白下拉式方塊。</para>
     </step>
     <step>
      <para>重複此步驟以新增更多資源。</para>
      <para>由於順序條件約束定義的是不同資源之間的相依性，因此您至少需要有兩個資源。頂層資源首先啟動，然後是第二層，依此類推。通常，資源停止時會使用相反順序。</para>
     </step>
     <step>
      <para>若要交換順序條件約束中不同資源的順序，按一下其中一個資源的向上箭頭圖示，將該資源換至輸入項的上方。 </para>
     </step>
    </substeps>
   </step>
   <step>
    <para> 需要時可以為每個資源指定更多參數 (例如 <literal>Started</literal>、<literal>Stopped</literal>、<literal>Master</literal>、<literal>Slave</literal>、<literal>Promote</literal> 和 <literal>Demote</literal>)︰按一下資源旁邊的空白下拉式方塊並選取所要的項目。</para>
   </step>
   <step>
    <para>確認變更以完成組態設定。螢幕頂部的訊息會顯示動作是否成功。</para>
   </step>
  </procedure>

  <figure pgwide="0">
   <title>Hawk2—順序條件約束</title>
   <mediaobject>
    <imageobject role="fo">
     <imagedata fileref="hawk2-order-constraint.png" width="100%" format="PNG"/>
    </imageobject>
    <imageobject role="html">
     <imagedata fileref="hawk2-order-constraint.png" width="100%" format="PNG"/>
    </imageobject>
   </mediaobject>
  </figure>
  </sect2>
  
  <sect2 xml:id="sec.conf.hawk2.cons.set">
   <title>在條件約束中使用資源集</title>
  <para>
   若要用另一種方式來定義條件約束，您可以使用<xref linkend="sec.ha.config.basics.constraints.rscset" xrefstyle="select:title"/>，其順序語意與<xref linkend="sec.ha.config.basics.resources.advanced.groups" xrefstyle="select:title"/>相同。
   </para>
  
 
  
  <procedure xml:id="pro.hawk2.constraints.sets">
   <title>對條件約束使用資源集</title>
   <step>
    <para>
     若要在位置條件約束中使用資源集：
    </para>
    <substeps performance="required">
     <step>
      <para>
       遵照<xref linkend="pro.hawk2.constraints.location"/>中的指示，但<xref linkend="step.hawk2.loc.rsc" xrefstyle="select:label"/> 除外︰透過按 <keycap function="control"/> (或 <keycap function="shift"/>) 及滑鼠選取多個資源，而不是選取單個資源。如此就會在位置條件約束中建立一個資源集。
      </para>
     </step>
      <step>
      <para>
       若要從位置條件約束中移除某個資源，請在按住 <keycap function="control"/> 的同時再次按一下該資源即可將其取消選取。 
      </para>
     </step>
    </substeps>
   </step>
   <step>
    <para> 若要在並存或順序條件約束中使用資源集： </para>
    <substeps performance="required">
     <step>
      <para> 遵照<xref linkend="pro.hawk2.constraints.colocation"/>或<xref linkend="pro.hawk2.constraints.order"/>中的指示，但用於為條件約束定義資源的步驟除外 (<xref linkend="step.hawk2.col.rsc" xrefstyle="select:label"/> 或<xref linkend="step.hawk2.order.rsc"/>)︰ </para>
     </step>
     <step>
      <para>新增多個資源。</para>
     </step>
     <step>
      <para>若要建立資源集，按一下資源旁邊的鏈結圖示，將其鏈結到上方的資源。屬於資源集的資源四周以框架圍起，以此標示資源集。</para>
     </step>
     <step>
      <para> 您也可以將多個資源併入某個資源集，或建立多個資源集。 </para>
      <figure>
       <title>Hawk2—一個並存條件約束中的兩個資源集</title>
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="hawk2-constraint-set.png" width="100%" format="PNG"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="hawk2-constraint-set.png" width="100%" format="PNG"/>
        </imageobject>
       </mediaobject>
      </figure>
     </step>
     <step>
      <para> 若要解除資源與其上方資源之間的鏈結，按一下該資源旁邊的剪刀圖示。 </para>
     </step>
    </substeps>
   </step>
   <step>
    <para>
     確認變更以完成條件約束組態。
    </para>
   </step>
  </procedure>
  </sect2>
  
  <sect2 xml:id="sec.conf.hawk2.cons.more">
   <title>更多資訊</title>
   <para> 如需設定條件約束的詳細資訊，以及關於順序與並存基本概念的詳細背景資訊，請參閱 <link xlink:href="http://www.clusterlabs.org/doc/"/> 上提供的文件： </para>
   <itemizedlist>
    <listitem>
     <para>  《<citetitle>Pacemaker Explained</citetitle>》(Pacemaker 說明) 的「<citetitle>Resource Constraints</citetitle>」(資源條件約束) 一章
     </para>
    </listitem>
    <listitem>
     <para>
      《<citetitle>Colocation Explained</citetitle>》(並存說明)
     </para>
    </listitem>
    <listitem>
     <para>
      《<citetitle>Ordering Explained</citetitle>》(順序說明)
     </para>
    </listitem>
   </itemizedlist>
  </sect2>
  
  <sect2 xml:id="sec.conf.hawk2.failover">
   <title>指定資源容錯移轉節點</title>
   <para>
    若資源失敗，系統會自動將其重新啟動。若在目前節點上無法將其重新啟動，或資源已在目前節點上失敗 N 次，則資源會嘗試容錯移轉至其他節點。您可以定義一個數值，讓資源在失敗該次數 (<literal>migration-threshold</literal>) 之後移轉至新節點。如果叢集中有兩個以上的節點，則某個資源應容錯移轉至哪個節點由 High Availability 軟體來選擇。
   </para>
   <para>
    您可以執行以下步驟指定資源容錯移轉至某個特定節點：
   </para>
   <procedure xml:id="pro.hawk2.failover">
    <title>指定容錯移轉節點</title>
    <step>
     <para>登入 Hawk2︰</para>
     <screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
    </step>
    <step>
     <para>
      依<xref linkend="pro.hawk2.constraints.location"/> 所述為該資源設定位置條件約束。
     </para>
    </step>
    <step>
     <para>
      依<xref linkend="pro.conf.hawk2.rsc.modify" xrefstyle="select:label title nopage"/>中的<xref linkend="step.hawk2.rsc.modify.params" xrefstyle="select:label"/> 所述將 <literal>migration-threshold</literal> 中繼屬性新增至該資源，並為該 migration-threshold 輸入一個值。該值應該為小於 INFINITY 的正數。
     </para>
    </step>
    <step>
     <para>
      若要讓資源的 failcount 自動過期，請依<xref linkend="pro.ha.config.hawk.primitives" xrefstyle="select:label title nopage"/>中的<xref linkend="step.ha.config.hawk.meta-attr" xrefstyle="select:label"/> 所述將 <literal>failure-timeout</literal> 中繼屬性新增至該資源，並為該 <literal>failure-timeout</literal> 輸入一個<guimenu>值</guimenu>。
     </para>
     <informalfigure>
      <mediaobject>
       <imageobject role="fo">
        <imagedata fileref="hawk2-failover-node.png" width="100%" format="PNG"/>
       </imageobject>
       <imageobject role="html">
        <imagedata fileref="hawk2-failover-node.png" width="100%" format="PNG"/>
       </imageobject>
      </mediaobject>
      </informalfigure>  
    </step>
    <step>
     <para>
      若要指定具有資源優先設定的其他容錯移轉節點，請建立其他位置條件約束。
     </para>
    </step>
   </procedure>
   <para>
    <xref linkend="ex.ha.config.basics.failover"/> 中演示了關於 migration-threshold 和 failcount 的程序流程。
   </para>
   <para>
    您也可以隨時手動清理資源的 failcount，而不是等待資源的 failcount 自動過期。如需詳細資訊，請參閱<xref linkend="sec.conf.hawk2.manage.cleanup"/>。
   </para>
  </sect2>

  <sect2 xml:id="sec.config.hawk2.failback">
   <title>指定資源錯誤回復節點 (資源粘性)</title>
   <para>
    當原始節點重新回到線上和叢集中時，資源可能會回復至該節點。若要防止此狀況，或要為資源指定不同的錯誤回復節點，請變更資源的粘性值。您可以在建立資源時指定資源粘性，也可以在以後指定。
   </para>
   <para>
    有關不同資源粘性值的含義，請閱<xref linkend="sec.ha.config.basics.failback"/>。
   </para>
   <procedure xml:id="pro.hawk2.stickiness">
    <title>指定資源粘性</title>
     <step>
      <para>登入 Hawk2︰</para>
      <screen>https://<replaceable>HAWKSERVER</replaceable>:7630/</screen>
     </step>
    <step>
     <para> 依<xref linkend="pro.conf.hawk2.rsc.modify" xrefstyle="select:label title nopage"/> 中的<xref linkend="step.hawk2.rsc.modify.params" xrefstyle="select:label"/> 所述將 <literal>resource-stickiness</literal> 中繼屬性新增至資源。 </para>
    </step>
    <step>
     <para>
      為 <literal>resource-stickiness</literal> 指定介於 <literal>-INFINITY</literal> 和 <literal>INFINITY</literal> 之間的值。
     </para>
     <informalfigure>
      <mediaobject>
      <imageobject role="fo">
      <imagedata fileref="hawk2-rsc-stickiness.png" width="100%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="hawk2-rsc-stickiness.png" width="100%" format="PNG"/>
      </imageobject>
      </mediaobject>
      </informalfigure>
    </step>
   </procedure>
  </sect2>
 </sect1>
