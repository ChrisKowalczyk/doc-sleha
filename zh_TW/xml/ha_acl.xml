<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<chapter xml:base="ha_acl.xml" id="cha.ha.acl">
 <title>存取控制清單</title>
 <abstract>
  <para> crm 外圍程序 (crmsh) 或 Hawk 等叢集管理工具可由 <systemitem class="username">root</systemitem> 或 <systemitem class="groupname">haclient</systemitem> 群組中的任何使用者使用。依預設，這些使用者擁有完整的讀取/寫入存取權。若要限制存取權或指定更精細的存取權限，可以使用<emphasis>存取控制清單</emphasis> (ACL)。 </para>

  <para> 存取控制清單由一組排序的存取規則構成。每個規則允許對一部分叢集組態進行讀取或寫入存取，或者拒絕對該部分進行存取。多個規則通常會組合起來構成特定的角色，這樣便可以將使用者指定到與其任務相符的角色。 </para>
 </abstract>
 <sect1 id="sec.ha.acl.require">
  <title>要求和必要條件</title>

  <para> 在您開始對叢集使用 ACL 前，請確定符合下列條件： </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para> 請使用 NIS、Active Directory 或者透過手動將相同使用者新增至所有節點的方式，來確保叢集中的所有節點上擁有相同的使用者。 </para>
   </listitem>
   <listitem>
    <para> 您要使用 ACL 修改其存取權限的所有使用者都必須屬於 <systemitem class="groupname">haclient</systemitem> 群組。
    </para>
   </listitem>
   <listitem>
    <para> 所有使用者都需要使用 crmsh 的絕對路徑 <filename>/usr/sbin/crm</filename> 來執行 crmsh。 </para>
   </listitem>
   <listitem>
    <para> 如果非特權使用者要執行 crmsh，則需要使用 <filename>/usr/sbin</filename> 延伸其 <envar>PATH</envar> 變數。 </para>
   </listitem>
  </itemizedlist>

  <important>
   <title>預設存取權限</title>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>ACL 是一個選擇性功能。ACL 預設處於停用狀態。
     </para>
    </listitem>
    <listitem>
     <para>如果未啟用 ACL，<systemitem class="username">root</systemitem> 以及屬於 <systemitem class="groupname">haclient</systemitem> 群組的所有使用者對於叢集組態將擁有完整的讀取/寫入存取權。</para>
    </listitem>
    <listitem>
     <para>即使啟用並設定了 ACL，<systemitem class="username">root</systemitem> 和預設 CRM 擁有者 <systemitem class="username">hacluster</systemitem> 也<emphasis>永遠</emphasis>擁有對叢集組態的完整存取權。</para>
    </listitem>
   </itemizedlist>
  </important>

  <para> 若要使用 ACL，您需要瞭解一些 XPath 方面的知識。XPath 是一種用於在 XML 文件中選取節點的語言。請參閱 <ulink url="http://en.wikipedia.org/wiki/XPath"/> 或在 <ulink url="http://www.w3.org/TR/xpath/"/> 上查詢規格。 </para>
 </sect1>
 
 <sect1 id="sec.ha.acl.enable">
  <title>在叢集中啟用 ACL</title>
  <para>在開始設定 ACL 之前，需要先<emphasis>啟用</emphasis> ACL。若要實現此目的，請在 crmsh 中使用以下指令：</para>
  <screen><prompt role="root">root # </prompt><command>crm</command> configure property enable-acl=true</screen>

  <para>也可以依照<xref linkend="pro.ha.acl.enable.hawk"/>所述使用 Hawk。</para>
  <procedure id="pro.ha.acl.enable.hawk">
   <title>使用 Hawk 啟用 ACL</title>

   <step performance="required">
    <para> 啟動網頁瀏覽器並依<xref linkend="sec.ha.config.hawk.intro.connect"/> 所述登入叢集。 </para>
   </step>
   <step performance="required">
    <para> 在左側導覽列中選取<guimenu>叢集內容</guimenu>。 </para>
   </step>
   <step performance="required">
    <para>在 <guimenu>CRM 組態</guimenu>群組中，從空白下拉式方塊中選取 <guimenu>enable-acl</guimenu> 屬性，然後按一下加號圖示新增該屬性。 </para>
   </step>
   <step performance="required">
    <para>若要設定 <literal>enable-acl=true</literal>，請啟用 <literal>enable-acl</literal> 旁邊的核取方塊，並確認您所做的變更。 </para>
   </step>
  </procedure>

 </sect1>


 <sect1 id="sec.ha.acl.basics">
  <title>ACL 的基本知識</title>

  <para> 存取控制清單由一組排序的存取規則構成。每個規則允許對一部分叢集組態進行讀取或寫入存取，或者拒絕對該部分進行存取。多個規則通常會組合起來構成特定的角色，這樣便可以將使用者指定到與其任務相符的角色。ACL 角色是一組用於描述 CIB 存取權限的規則。規則由以下元素組成： </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>存取權限，例如<literal>讀取</literal>、<literal>寫入</literal>或<literal>拒絕</literal></para>
   </listitem>
   <listitem>
    <para> 定義在何種情況下套用規則的規格。此規格可以是標記、ID 參考、標記與 ID 參考的組合，或者是 XPath 運算式。
    </para>
   </listitem>
  </itemizedlist>

  <para> 通常，便利的做法是將 ACL 綁定到角色，並將特定的角色指定給使用者。您也可以直接為個別使用者設定 ACL。</para>

  <para> 建立 ACL 規則的方法有兩種： </para>

  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para><xref linkend="sec.ha.acl.config.xpath"/>。您需要瞭解基礎 XML 的結構才能建立 ACL 規則。 </para>
   </listitem>
   <listitem>
    <para><xref linkend="sec.ha.acl.config.tag"/>。建立要套用至相符物件的簡寫語法與 ACL 規則。</para>
   </listitem>
  </itemizedlist>

  <sect2 id="sec.ha.acl.config.xpath">
   <title>透過 XPath 運算式設定 ACL 規則</title>
   <para> 若要透過 XPath 管理 ACL 規則，您需要瞭解基礎 XML 的結構。使用以下指令擷取結構，該指令將以 XML 格式顯示您的叢集組態 (請參閱<xref linkend="ex.ha.acl.excerpt"/>)：
   </para>
   <screen><prompt role="root">root # </prompt><command>crm</command> configure show xml</screen>
   
   <example id="ex.ha.acl.excerpt">
    <title>XML 中的叢集組態摘錄</title>
    <screen>&lt;num_updates="59" 
      dc-uuid="175704363"
      crm_feature_set="3.0.9"
      validate-with="pacemaker-2.0"
      epoch="96"
      admin_epoch="0"
      cib-last-written="Fri Aug  8 13:47:28 2014"
      have-quorum="1"&gt;
  &lt;configuration&gt;
    &lt;crm_config&gt;
       &lt;cluster_property_set id="cib-bootstrap-options"&gt;
        &lt;nvpair name="stonith-enabled" value="true" id="cib-bootstrap-options-stonith-enabled"/&gt;
        &lt;nvpair name="no-quorum-policy" value="ignore" id="cib-bootstrap-options-no-quorum-policy"/&gt;
         [...]
      &lt;/cluster_property_set&gt;
    &lt;/crm_config&gt;
    &lt;nodes&gt;
      &lt;node id="175704363" uname="alice"/&gt;
      &lt;node id="175704619" uname="bob"/&gt;
    &lt;/nodes&gt;
    &lt;resources&gt; [...]  &lt;/resources&gt;
    &lt;constraints/&gt;
    &lt;rsc_defaults&gt; [...] &lt;/rsc_defaults&gt;
    &lt;op_defaults&gt; [...] &lt;/op_defaults&gt;
  &lt;configuration&gt;
&lt;/cib&gt;</screen>
   </example>
   <para> 您可以使用 XPath 語言在此 XML 文件中尋找節點。例如，若要選取根節點 (<literal>cib</literal>)，請使用 XPath 運算式 <literal>/cib</literal>。若要尋找全域叢集組態，請使用 XPath 運算式 <literal>/cib/configuration/crm_config</literal>。 </para>
   <para>例如，<xref linkend="tab.ha.acl.operator"/>顯示了用於建立<quote>operator</quote>角色的參數 (存取類型和 XPath 運算式)。具有此角色的使用者僅可執行第二欄中所述的任務 — 他們既不能重新設定任何資源 (例如，變更參數或操作)，也不能變更並存或順序條件約束的組態。 </para>
   
   <table id="tab.ha.acl.operator">
    <title>Operator 角色 — 存取類型和 XPath 運算式</title>
    <tgroup cols="2">
     <thead>
      <row>
       <entry>
        <para> 類型 </para>
       </entry>
       <entry>
        <para> XPath/說明 </para>
       </entry>
      </row>
     </thead>
     <tbody>
      <row>
       <entry>
        <para> 寫入 </para>
       </entry>
       <entry>
        <screen>//crm_config//nvpair[@name='maintenance-mode']</screen>
        <para> 開啟或關閉維護模式。 </para>
       </entry>
      </row>
      <row>
       <entry>
        <para> 寫入 </para>
       </entry>
       <entry>
        <screen>//op_defaults//nvpair[@name='record-pending']</screen>
        <para> 選擇是否要記錄待處理操作。 </para>
       </entry>
      </row>
      <row>
       <entry>
        <para> 寫入 </para>
       </entry>
       <entry>
        <screen>//nodes/node//nvpair[@name='standby']</screen>
        <para> 將節點設定為線上模式或待命模式。 </para>
       </entry>
      </row>
      <row>
       <entry>
        <para> 寫入 </para>
       </entry>
       <entry>
        <screen>//resources//nvpair[@name='target-role']</screen>
        <para> 啟動、停止、升級或降級任何資源。 </para>
       </entry>
      </row>
      <row>
       <entry>
        <para> 寫入 </para>
       </entry>
       <entry>
        <screen>//resources//nvpair[@name='is-managed']</screen>
        <para> 選擇某個資源應否受管理。 </para>
       </entry>
      </row>
      <row>
       <entry>
        <para> 寫入 </para>
       </entry>
       <entry>
        <screen>//constraints/rsc_location</screen>
        <para> 將資源從一個節點移轉/移動到另一個節點。 </para>
       </entry>
      </row>
      <row>
       <entry>
        <para> 讀取 </para>
       </entry>
       <entry>
        <screen>/cib</screen>
        <para> 檢視叢集的狀態。 </para>
       </entry>
      </row>
     </tbody>
    </tgroup>
   </table>
  </sect2>

  <sect2 id="sec.ha.acl.config.tag">
   <title>透過標記縮寫設定 ACL 規則</title>
   <para> 不想處理 XML 結構的使用者可以使用更簡單的方法，就是使用標記規範和/或參考的組合。 </para>
   <para> 例如，您可以考慮使用如下 Xpath： </para>
   <screen>/cib/resources/primitive[@id='rsc1']</screen>
   <para>
    <literal>primitive</literal> 是一個參考 ID 為 <literal>rsc1</literal> 的資源。簡寫語法為： </para>
   <screen>tag: "primitive"  ref:"rsc1"</screen>
   <para> 這也適用於條件約束。以下是詳細的 XPath： </para>
   <screen>/cib/constraint/rsc_location</screen>
   <para> 相應的簡寫語法如下： </para>
   <screen>tag: "rsc_location"</screen>
   <para> 簡寫語法可以用在 crmsh 和 Hawk 中。CIB 精靈知道如何將 ACL 規則套用至相符物件。 
   </para>
  </sect2>
 </sect1>
 <sect1 id="sec.ha.acl.config.hawk">
  <title>使用 Hawk 設定 ACL</title>

  <para> 下面的程序說明如何透過定義 <literal>monitor</literal> 角色並將其指定給使用者，來設定對叢集組態的唯讀存取權。您也可以依照<xref linkend="pro.ha.acl.crm"/>所述使用 crmsh 來實現此目的。</para>
  
  <procedure id="pro.ha.acl.hawk">
   <title>使用 Hawk 新增 Monitor 角色並指定使用者</title>
   
   <step performance="required">
    <para> 啟動網頁瀏覽器並依<xref linkend="sec.ha.config.hawk.intro.connect"/> 所述登入叢集。 </para>
   </step>
   <step performance="required">
    <para> 在左側導覽列中選取<guimenu>存取控制清單</guimenu>。檢視窗會顯示已定義的<guimenu>角色</guimenu>與<guimenu>使用者</guimenu>。</para>
   </step>
   <step performance="required">
    <para>
     若要定義 ACL 角色：
    </para>
    <substeps performance="required">
     <step performance="required">
      <para>
       選取<guimenu>角色</guimenu>類別並按一下加號圖示。
      </para>
     </step>
       <step performance="required">
        <para> 輸入唯一的<guimenu>角色 ID</guimenu>，例如 <literal>monitor</literal>。 </para>
       </step>
       <step performance="required">
        <para>本範例是要定義一個 <literal>monitor</literal> 角色，因此請從<guimenu>權限</guimenu>下拉式方塊中選取<literal>讀取</literal>。</para>
       </step>
       <step performance="required">
        <para>在 <guimenu>Xpath</guimenu> 文字方塊中，輸入 Xpath 運算式 <literal>/cib</literal> 並按一下<guimenu>建立角色</guimenu>。 </para>
        <para>這會建立一個名為 <literal>monitor</literal> 的新角色，為其設定<literal>讀取</literal>權限，並使用 XPath 運算式 <literal>/cib</literal> 將其套用至 CIB 中的所有元素。 </para>
       </step>
       <step performance="required">
        <para>如果需要，您可以透過按一下加號圖示並指定相應的參數，來新增更多的存取權限和 XPath 引數。確認您的變更。</para>
       </step>
      </substeps>
   </step>
   <step performance="required">
    <para>
     將角色指定給使用者：
    </para>
    <substeps performance="required">
     <step performance="required">
      <para> 選取<guimenu>使用者</guimenu>類別並按一下加號圖示。</para>
      <para><guimenu>建立使用者</guimenu>檢視窗會顯示可用的角色。此外，它還包含額外的一行，用於設定該使用者的個別 ACL 規則。在該檢視窗中，您可以向使用者指定一或多個角色，<emphasis>或者</emphasis>為該使用者定義一或多個不同的規則。選取某個角色時，各個規則的行將會消失；取消選取某個角色時，該行將會顯示。您無法既指定角色又定義個別規則。 </para>
     </step>
     <step performance="required">
      <para> 輸入唯一的<guimenu>使用者 ID</guimenu>，例如 <literal>tux</literal>。請確定此使用者屬於 <systemitem class="groupname">haclient</systemitem> 群組。</para>
     </step>
     <step performance="required">
      <para>若要將角色指定給使用者，請從<guimenu>角色</guimenu>中選取相應的項目。對於本範例，請選取您所建立的 <literal>monitor</literal> 角色。</para>
      <para>若要取消選取一或多個角色，請再次按一下相應的項目。如果未選取任何角色，用於定義個別規則的行將再次顯示。</para>
      <figure>
       <title>Hawk — 向使用者指定角色或規則</title>
       <mediaobject>
        <imageobject role="fo">
         <imagedata fileref="hawk-acl-user-assign.png" width="70%" format="PNG"/>
        </imageobject>
        <imageobject role="html">
         <imagedata fileref="hawk-acl-user-assign.png" width="70%" format="PNG"/>
        </imageobject>
       </mediaobject>
      </figure>
     </step>
     <step performance="required">
      <para>如果您要定義個別規則，請選取一個<guimenu>權限</guimenu>，並為要定義的規則輸入相應的 Xpath 參數。按一下加號圖示可定義更多規則。</para>
     </step>
     <step performance="required">
      <para>確認您的選擇，然後按一下<guimenu>建立使用者</guimenu>將角色或規則指定給使用者。</para>
     </step>
    </substeps>
   </step>
  </procedure>
  
  <para>若要設定對資源或條件約束的存取權限，也可以依照<xref linkend="sec.ha.acl.config.tag"/>所述使用簡寫語法。例如，如果您有一個 ID 為 <literal>rsc1</literal> 的基本資源，請為<guimenu>標記</guimenu>和<guimenu>參考</guimenu>輸入以下值：<literal>primitive</literal> 和 <literal>rsc1</literal>。只輸入 <literal>rsc1</literal> 做為<guimenu>參考</guimenu>的好處是，可以使基本資源與本地資源管理員資源 (LRM) 相符。如此，您便可以設定 <literal>rsc1</literal>，同時清理其狀態。 </para>
 </sect1>
 
 <sect1 id="sec.ha.acl.config.crm">
  <title>使用 crmsh 設定 ACL</title>

  <para> 下面的程序說明如何透過定義 <literal>monitor</literal> 角色並將其指定給使用者，來設定對叢集組態的唯讀存取權。 </para>

  <procedure id="pro.ha.acl.crm">
   <title>使用 crmsh 新增 Monitor 角色並指定使用者</title>
   <step performance="required">
    <para> 以 <systemitem class="username">root</systemitem> 身分登入。 </para>
   </step>
   <step performance="required">
    <para> 啟動 crmsh 的互動模式： </para>
    <screen><prompt role="root">root # </prompt><command>crm</command> configure
<prompt role="custom">crm(live)configure# </prompt></screen>
   </step>
   <step performance="required">
    <para> 定義 ACL 角色： </para>
    <substeps performance="required">
     <step performance="required">
      <para> 使用 <command>role</command> 指令定義新角色：</para>
      <screen><prompt role="custom">crm(live)configure# </prompt><command>role</command> monitor read xpath:"/cib"</screen>
      <para> 上面的指令會建立一個名為 <literal>monitor</literal> 的新角色，為其設定<literal>讀取</literal>權限，並使用 XPath 運算式 <literal>/cib</literal> 將其套用至 CIB 中的所有元素。如果需要，您可以新增更多存取權限及 XPath 引數。 </para>
      </step>
     <step performance="required">
      <para> 根據需要新增其他角色。 </para>
     </step>
    </substeps>
   </step>
   <step performance="required">
    <para> 將角色指定給一或多個使用者。請確定這些使用者屬於 <systemitem class="groupname">haclient</systemitem> 群組。 </para>
    <screen><prompt role="custom">crm(live)configure# </prompt><command>acl_target</command> tux monitor</screen>
   </step>
   <step performance="required">
    <para> 檢查您的變更： </para>
    <screen><prompt role="custom">crm(live)configure# </prompt><command>show</command></screen>
   </step>
   <step performance="required">
    <para> 提交您的變更： </para>
    <screen><prompt role="custom">crm(live)configure# </prompt><command>commit</command></screen>
   </step>
  </procedure>
  <para>若要設定對資源或條件約束的存取權限，也可以依照<xref linkend="sec.ha.acl.config.tag"/>所述使用簡寫語法。如果您有一個 ID 為 <literal>rsc1</literal> 的基本資源，請使用以下表示法來設定存取權限：<literal>write tag:"primitive" ref:"rsc1"</literal>。您也可以使用 <literal>write ref:"rsc1"</literal> 來參考該 ID。這樣做的好處是，可以使基本資源與本地資源管理員資源 (LRM) 相符。如此，您便可以設定 <literal>rsc1</literal>，同時清理其狀態。 </para>
  
 </sect1>
 <sect1 id="sec.ha.acl.moreinfo">
  <title>更多資訊</title>

  <para> 請參閱 <ulink url="http://www.clusterlabs.org/doc/acls.html"/>。 </para>
 </sect1>
</chapter>
