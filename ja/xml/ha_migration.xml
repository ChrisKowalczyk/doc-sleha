<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE appendix PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd">
<!--
*********************************
Please see LICENSE.txt for this document's license.
*********************************
-->
<appendix xml:base="ha_migration.xml" id="app.ha.migration">
 <title>クラスタアップグレードとソフトウェアパッケージの更新</title>
 <abstract>
  <para>この章では、次の2つの異なるシナリオ(<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase>の別バージョン(メジャーリリースまたはサービスパック)へのクラスタアップグレード、およびクラスタノード上の各パッケージの更新)について説明します。 </para>
 </abstract>
   
 <sect1 id="sec.ha.migration.terminology">
  <title>用語集</title>
  <para>次に、この章で使用される最も重要な用語の定義を示します。</para>
  
  <variablelist>
   <varlistentry>
    <term>メジャーリリース</term>
    <term>一般出荷(GA)バージョン</term>
    <listitem>
     <para> SUSE Linux Enterprise (または任意のソフトウェア製品)のメジャーリリースとは、新しい機能やツールを導入する、非推奨になっていたコンポーネントを削除する、後方互換性のない変更が存在する、などの特徴を持った新バージョンです。
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>サービスパック(SP)</term>
    <listitem>
     <para> 複数のパッチを組み合わせて、インストールまたは展開しやすい形式にします。サービスパックには番号が付けられ、通常、プログラムのセキュリティ修正、更新、アップグレード、または拡張機能が含まれます。 </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>アップデート</term>
    <listitem>
     <para> パッケージの新しい<emphasis>マイナー</emphasis>バージョンのインストール。 </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>アップグレード</term>
    <listitem>
     <para> パッケージまたは配布の新しい<emphasis>主要</emphasis>バージョンのインストール。これにより<emphasis>新機能</emphasis>がもたらされます。
     </para>
    </listitem>
   </varlistentry>
  </variablelist>
 </sect1>
 
 <sect1 id="sec.ha.migration.upgrade">
  <title>最新の製品バージョンへのクラスタアップグレード</title>
  <para>サポートされるアップグレードパスおよびアップグレードの実行方法は、クラスタが実行されている現在の製品バージョンおよび移行したいターゲットバージョンによって異なります。アップグレードに関する一般的な情報については、『<citetitle/>SUSE Linux Enterprise Server 12  導入ガイド』の「<citetitle/>SUSE Linux Enterpriseのアップデート」の章を参照してください。<ulink url="http://www.suse.com/documentation/"/>で入手できます。 </para>
 

  <sect2 id="sec.ha.migration.upgrade.sle12">
   <title>SLE HA 11 SP3からSLE HA 12へのアップグレード</title>

   <para><phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12へ正常にアップグレードするには、ご使用のクラスタで最新バージョンのSUSE Linux Enterprise Serverおよび<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> (11 SP3)を実行している必要があります。ご使用のクラスタがそれより古い製品バージョンに基づいている場合は、まず、SUSE Linux Enterprise Serverおよび<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 11 SP3にアップグレードしてください。アップグレードの詳細については、『SUSE Linux Enterprise High Availability Extension 11 管理ガイド<citetitle/><phrase role="productname"><phrase os="sles"/></phrase><emphasis/>』の「最新製品バージョンへのクラスタアップグレード<citetitle/>」の章を参照してください。<ulink url="http://www.suse.com/documentation/"/>で入手できます。 </para>

   <para>High Availability Extension 12の各コンポーネント(<filename>/etc/corosync/corosync.conf</filename>、OCFS2のディスクフォーマットなど)は大きく変更されているため、このシナリオでは<literal>rolling upgrade</literal>の実行がサポートされていません。<xref linkend="pro.ha.migration.sle12"/>で説明されているように、すべてのクラスタノードをオフラインにしてから、クラスタを全体として移行する必要があります。<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 11/<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12で実行する混合クラスタはサポートされていません。</para>


   <procedure id="pro.ha.migration.sle12">
    <title>SLE HA 12へのクラスタアップグレード</title>
    <important>
     <title>アップグレード前に必要な準備</title>
     <itemizedlist mark="bullet" spacing="normal">
      <listitem>
       <para>システムバックアップが最新で、復元可能かどうかを確認します。</para>
      </listitem>
      <listitem>
       <para>運用環境で実行する前に、まず、クラスタセットアップのステージングインスタンスでアップグレード手順をテストします。</para>
       <para>これにより、メンテナンス期間に要するタイムフレームを予測できます。発生する可能性のある予期しない問題を検出し、解決するのにも役立ちます。</para>
      </listitem>
     </itemizedlist>
    </important>
    <para>クラスタノードごとに次の手順を実行します。</para>
    <step performance="required">
     <para>各クラスタノードにログインし、次のコマンドを使用してクラスタスタックを停止します。</para>
     <screen><prompt role="root">root # </prompt> rcopenais stop</screen>
    </step>
    <step performance="required">
     <para>クラスタノードごとに、SUSE Linux Enterprise Server 11 SP3からSUSE Linux Enterprise Server 12、および<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 11 SP3から<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12へのアップグレードを実行します。Geo Clusteringを使用する場合は、『<citetitle/>Geo Clustering for SUSE Linux Enterprise High Availability Extensionクイックスタート』で説明されている各アドオンをインストールします。お使いの製品のアップグレード方法の詳細については、『<citetitle/>SUSE Linux Enterprise Server 12 導入ガイド』の「<citetitle/>SUSE Linux Enterpriseのアップグレード」の章を参照してください。<ulink url="http://www.suse.com/documentation/"/>で入手できます。</para>
    </step>
    <step performance="required">
     <para>アップグレードプロセスが完了した後で、SUSE Linux Enterprise Serverおよび<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase>のバージョン12がインストールされた各ノードを再起動します。</para>
    </step>
    <step performance="required">
     <para>クラスタセットアップでOCFS2を使用する場合は、次のコマンドを実行して、オンデバイス構造をアップデートします。</para>
     <screen><prompt role="root">root # </prompt> tunefs.ocfs2 --update-cluster-stack <replaceable>PATH_TO_DEVICE</replaceable></screen>
     <para><phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase> 12に付属しているアップデートされたOCFS2バージョンで必要とされるディスクに、パラメータが追加されます。</para>
    </step>
    <step performance="required">
     <para>Corosyncバージョン2の<filename>/etc/corosync/corosync.conf</filename>をアップデートするには:</para>
     <substeps performance="required">
      <step performance="required">
       <para>1つのノードにログインして、YaSTクラスタモジュールを起動します。</para>
      </step>
      <step performance="required">
       <para><guimenu>通信チャネル</guimenu>カテゴリに切り替えて、新しいパラメータ(<guimenu>クラスタ名</guimenu>および<guimenu>予想票数</guimenu>)の値を入力します。詳細については、<xref linkend="pro.ha.installation.setup.channel1"/>を参照してください。</para>
       <para>Corosyncバージョン2で無効になっていたり、見つからない他のオプションをYaSTが検出する場合、変更を求めるプロンプトが表示されます。 </para>
       
      </step>
      <step performance="required">
       <para>YaSTで変更内容を確認し、<filename>/etc/corosync/corosync.conf</filename>を更新します。</para>
      </step>
      <step performance="required">
       <para>クラスタに対してCsync2が設定されている場合は、次のコマンドを使用して、アップデートされたCorosync設定を他のクラスタノードにプッシュします。</para>
       <screen><prompt role="root">root # </prompt><command>csync2</command> <option>-xv</option></screen>
       <para>Csync2の詳細については、<xref linkend="sec.ha.installation.setup.csync2"/>を参照してください。 </para>
       <para>または、<filename>/etc/corosync/corosync.conf</filename>をすべてのクラスタノードに手動でコピーして、更新されたCorosync設定の同期を取ります。</para>
      </step>
     </substeps>
    </step>
    <step performance="required">
     <para>各ノードにログインして、次のコマンドを使用してクラスタスタックを起動します。</para>
     <screen><prompt role="root">root # </prompt> systemctl start pacemaker.service</screen>
    </step>
    <step performance="required">
     <para> <command>crm status</command>またはHawkを使用してクラスタの状態を確認します。</para>
    </step>
   </procedure>
   
   <para>既存のGeoクラスタセットアップがあり、それをHigh Availability Extension 12およびGeo Clustering for SUSE Linux Enterprise High Availability Extension 12とともに実行するようにアップグレードする場合は、『Geo Clustering for SUSE Linux Enterprise High Availability Extensionクイックスタート<citetitle/>』の追加情報を参照してください。<ulink url="http://www.suse.com/documentation/"/>で入手できます。「<citetitle/>SLE HA 11 SP3からSLE HA 12へのアップグレード」のセクションを参照してください。 </para>

   <note>
    <title>アップグレード後の復帰</title>
    <para>
      製品バージョン12へのアップグレードプロセス後に、製品バージョン11に戻す処理は、<emphasis/>サポートされていません。 </para>
   </note>
  </sect2>
 </sect1>


 <sect1 id="sec.ha.update">
  <title>クラスタノード上のソフトウェアパッケージの更新</title>

  <para>ノード上にパッケージ更新をインストールする前に、次の内容を確認してください。 </para>
  <itemizedlist mark="bullet" spacing="normal">
   <listitem>
    <para>その更新は、<phrase role="productname"><phrase os="sles">SUSE Linux Enterprise High Availability Extension</phrase></phrase>またはGeo Clustering for SUSE Linux Enterprise High Availability Extensionアドオンに属するパッケージに影響しますか。影響する場合は、ソフトウェアの更新を開始する前に、ノード上でクラスタスタックを停止します。</para>
    <screen><prompt role="root">root # </prompt> systemctl stop pacemaker.service</screen>
   </listitem>
   <listitem>
    <para>パッケージ更新には再起動が必要ですか。必要な場合は、ソフトウェアの更新を開始する前に、ノード上でクラスタスタックを停止します。</para>
    <screen><prompt role="root">root # </prompt> systemctl stop pacemaker.service</screen>
   </listitem>
  </itemizedlist>
  <para>これらの状況のいずれにも該当しない場合は、クラスタスタックを停止する必要はありません。その場合は、ソフトウェアの更新を開始する前に、クラスタを保守モードにします。</para>
  <screen><prompt role="root">root # </prompt><command>crm</command> configure property maintenance-mode=true</screen>
  <para>保守モードの詳細については、<xref linkend="sec.ha.config.basics.maint.mode"/>を参照してください。</para>

  <warning>
   <title>更新中のアクティブなクラスタスタック</title>
   <para> ソフトウェアの更新中にノード上のクラスタリソースマネージャがアクティブな場合、アクティブノードのフェンシングのような予期しない結果を招く場合があります。 </para>
  </warning>

  <para>更新が正常にインストールされたら、次のコマンドを使用して、クラスタの保守モードを解除してください。</para>
  <screen><prompt role="root">root # </prompt><command>crm</command> configure property maintenance-mode=true</screen>
  <para>または、次のコマンドを使用して、各ノード上でクラスタスタックを再起動してください。</para>
  <screen><prompt role="root">root # </prompt> systemctl start pacemaker.service</screen>
</sect1>
 
  
 <sect1 id="sec.ha.migration.more">
  <title>その他の情報</title>

  <para>
   アップグレード先の製品の変更点と新機能の詳細については、それぞれのリリースノートを参照してください。リリースノートは、<ulink url="https://www.suse.com/releasenotes/"/>で入手できます。
  </para>
 </sect1>
</appendix>
