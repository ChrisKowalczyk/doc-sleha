<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd" [
 <!ENTITY % NOVDOC.DEACTIVATE.IDREF "INCLUDE">
 <!ENTITY % entities SYSTEM "entity-decl.ent">
 %entities;
]>
<!-- toms 2014-02-26:
  - rear-SUSE is not available anymore in SLE12 Beta1
  - No YaST module for Rear
  - 2014-05-14: Btrfs and Rear: 
    http://en.opensuse.org/SDB:Disaster_Recovery#All_filesystems_are_equal.2C_but_some_are_more_equal_than_others
-->

<!--Fates #310991, 312336-->
<!--taroth 2011-09-19: information sources: 
  /usr/share/doc/packages/rear/README
  /usr/share/doc/packages/rear-SUSE
  http://sourceforge.net/projects/rear/files/documentation/

-->
<chapter id="cha.ha.rear">
 <title>Disaster Recovery with &rear; (&rear.long;)</title>
 <abstract>
  <para>
   &rear.long; (formerly <quote>ReaR</quote>) is an administrator tool-set for creating
   disaster recovery images. The disaster recovery information can either be
   stored via the network or locally on hard disks, USB devices, DVD/CD-R,
   tape or similar media. The backup data is stored on a network file system
   (NFS).
  </para>

  <para>
   Keep in mind, &rear; needs to be configured and tested
   <emphasis>before</emphasis> any disaster happens. &rear; will not save
   you, if a disaster has already taken place.
  </para>
 </abstract>
 <warning>
  <title>Extensive Testing Required</title>
  <para>
   It is essential, whenever you create a rescue CD, to
   <emphasis>always</emphasis> test the disaster recovery with an
   <emphasis>identical</emphasis> test machine. Only if this procedure works
   satisfactorily, your disaster recovery system is correctly and reliably
   set up.
  </para>
 </warning>
  <!-- 2014-05-14: According to Johannes, this is now possible.
    Package has been rename from rear to rear<VERSION>. 
    However, rear<VERSION> conflicts with rear<VERSION+1>. This is made on
    purpose so customers get a notice when they try to install both.

    It is very likely that the rear version will change.
    
  -->
 <!--<warning>
  <title>No Version Upgrade for the &rear; Package</title>
  <para>
   &suse; does not deliver any updates for &rear;. It cannot be
   guaranteed that an existing &rear; disaster recovery setup will still
   work after the upgrade.
  </para>
  <para>
   If you do a &rear; version upgrade on your own, carefully revalidate that
   your particular &rear; disaster recovery procedure still works.
  </para>
 </warning>-->
 <sect1 id="sec.ha.rear.concept">
  <title>Conceptual Overview</title>
   <para>&rear; supports several backup tools (Tivoli Storage Manager, QNetix 
     Galaxy, Symantec NetBackup, EMC NetWorker, HP DataProtector) and can
     output its rescue medium to a CD or PXE environment. The restore step is 
     possible through NFS or CIFS and other network file systems.
  </para>
  <para>
    To use &rear; you need at least two identical systems: the main machine
   where your productive environment is stored and the test machine.
   <quote>Identical</quote> in this context means, for example, you can
   replace a network card with another one using the same Kernel driver. If
   a hardware component does not use the same driver, it is not considered
   identical by &rear;.
  </para> 
  <para>
   &sls; ships a disaster recovery system in the 
    <systemitem class="resource">rear<replaceable>VERSION</replaceable></systemitem> 
    package. 
  </para>
   <para>  
    &rear; is used in the following way:
  </para>

  <orderedlist>
   <listitem>
    <formalpara>
     <title>Preparation</title>
     <para>
      Make a bootable CD, backup system.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Testing</title>
     <para>
      Test the recovery process thoroughly and the backup on the same
      hardware as your main system <emphasis>before any disaster happens</emphasis>!
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Recovery</title>
     <para>
      Boot from the rescue CD and restore your system from your backup.
     </para>
    </formalpara>
   </listitem>
  </orderedlist>

  <para>
   To prepare the rescue media, the following steps are performed by &rear;:
  </para>

  <orderedlist>
   <title>Preparation of Rescue Media by &rear;</title>
   <listitem>
    <para>
     Gather system information from the target system.
    </para>
   </listitem>
   <listitem>
    <para>
     Store disk layout (partitioning, filesystems, LVM, RAID, and boot
     loader).
    </para>
   </listitem>
   <listitem>
    <para>
     Clone the system (Kernel drivers and modules, device driver
     configuration, network configuration, system software and tools).
    </para>
   </listitem>
   <listitem>
    <para>
     Backup system and user data.
    </para>
   </listitem>
   <listitem>
    <para>
     Create bootable rescue CD with system configuration.
    </para>
   </listitem>
  </orderedlist>

  <para>
   When a disaster occurrs, the recovery process consists of these actions:
  </para>

  <orderedlist>
   <title>Recovery Process</title>
   <listitem>
    <para>
     Boot from the rescue media.
    </para>
   </listitem>
   <listitem>
    <para>
     Restore the disk layout (partitions, RAID configurations, LVM, file
     systems).
    </para>
   </listitem>
   <listitem>
    <para>
     Restore system and user data.
    </para>
   </listitem>
   <listitem>
    <para>
     Restore boot loader.
    </para>
   </listitem>
   <listitem>
    <para>
     Reboot system.
    </para>
   </listitem>
  </orderedlist>
 
  <note>
    <title>&rear; and Subvolumes and Snapshots in btrfs Filesystem</title>
    <para>     
      Due to technical and conceptual issues, &rear; and the btrfs tools
      has some limitations you should be aware of:
    </para>
    <itemizedlist>
      <listitem>
        <formalpara>
          <title>btrfs with subvolumes, but no snapshots</title>
          <para>at least &rear; version 1.15 is required as this version
          supports restoring the btrfs subvolume structure. 
          The backup and restore of the data should work.</para>
        </formalpara>
      </listitem>
      <listitem>
        <formalpara>
          <title>btrfs with subvolumes that contain snapshots</title>
          <para>The usual backup and restore cannot work. Ordinary backup tools
          (for example, <command>tar</command>) cannot distinguish between
            data and btrfs snapshot structure.
          </para>
        </formalpara>
      </listitem>
    </itemizedlist>
  </note>
 </sect1>
  
 <sect1 id="sec.ha.rear.drp">
  <title>Preparing for the Worst Scenarios: Disaster Recovery Plans</title>

  <para>
   <emphasis>Before</emphasis> the worst scenario happens, take actions to
   prepare with a <emphasis>disaster recovery plan</emphasis>. A disaster
   recovery plan is a document where all risks, infrastructure, and the
   budget is being collected. Maybe you have already some plan in place, but
   here is the general overview:
  </para>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>Risk Analysis</title>
     <para>
      Conduct a solid risk analysis of your infrastructure. List all the
      possible threats and evaluate how serious they are. Determine how
      likely these threats are and prioritize them. It is recommended to use
      a simple categorization: probability and impact.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Budget Planing</title>
     <para>
      The outcome of the analysis is an overview, which risks can be
      tolerated and which are critical for your business. Ask yourself, how
      can you minimize risks and how much will it cost. Depending on how big
      your company is, spend two to fifteen percent of the overall IT budget
      on disaster recovery.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Disaster Recovery Plan Development</title>
     <para>
      Make checklists, test procedures, establish and assign priorities, and
      inventory your IT infrastructure. Define how to deal with a problem
      when some services in your infrastructure fail.
      <remark>emap: Very vague. 
              Examples would help or a reference to a source on how 
              to create an actual DR plan. Like redundant systems, 
              failover clusters, raids, etc.</remark>
      <remark>toms 2011-11-04: Yes, that's true, but that's the task
          of the administrators. It is only there to indicate, there is
          some work to do, and not just 'relax'. :)
     </remark>
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Test</title>
     <para>
      After defining an elaborate plan, test it. Test it at least once a
      year. Use the same testing hardware as your main IT infrastructure.
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 id="sec.ha.rear.config.rear">
  <title>Setting Up &rear;</title>
   <para>To configure &rear;, add your options into the configuration file
     <filename>/etc/rear/local.conf</filename>. The former file
     <filename>/etc/rear/sites.conf</filename> has been removed from the
     package. If you have such a file from your last setup, &rear; will still
     use it.
   </para>
   <para>Define your output method by using the <varname>OUTPUT</varname> 
     variable. For example, to output your recovery medium as ISO image, use
   </para>
   <screen>OUTPUT=ISO</screen>
   <para>After you have changed your configuration file, make sure everything
   is correct by running the following command:</para>
   <screen>rear dump</screen>
   <para>Examine the output and look for any errors.</para>
   
   <para>
     Find more information in the man page of
     &rear; (<command>man</command> <option>rear</option>).
   </para>    
 </sect1>
  
 <sect1 id="sec.ha.rear.config.nfs">
  <title>Storing your Backup on a NFS Server</title>
  <para>
   &rear; can be used in different scenarios. The following example uses a
   NFS server as backup storage:
  </para>

  <procedure id="pro.ha.rear.nfs-server-backup">
   <title>Storing Your Backup on a NFS Server</title>
   <step>
    <para>
     Set up a NFS server with &yast; as described in <citetitle>Sharing File
     Systems with NFS</citetitle> from
     <ulink
          url="http://www.suse.com/doc/sles11/book_sle_admin/data/cha_nfs.html"/>.
    </para>
   </step>
   <step>
    <para>
     Adapt the configuration file <filename>/etc/rear/local.conf</filename>. 
     Replace the <option>NETFS_URL</option> with your own values. 
     </para>
     <para>
     If your NFS host is not an IP address but a hostname, DNS must work
     when the backup is restored. Further options are listed in the <citetitle>Various 
       Settings</citetitle> section of  the documentation at
     <ulink url="http://rear.github.com/documentation/"/>.
     <remark>taroth 2012-06-11: todo for next revision - check if the 
            cited section is still available (the project's doc page has changed to 
            http://rear.github.com/documentation/ in the meantime,
            and the page currently says: "The Rear documentation is being revised 
            and updated - Under construction"</remark>
     <remark>toms 2014-05-14: Still under construction.</remark>
    </para>
<screen># Create ReaR rescue media as ISO image:
OUTPUT=ISO
# Store the backup file via NFS:
BACKUP=NETFS
# Only a NETFS_URL of the form 'nfs://host/path' is supported
# so that 'mount -o nolock -t nfs host:/path' works.
NETFS_URL=nfs://&subnetI;.1/nfs/rear/
# Keep an older copy of the backup in a HOSTNAME.old directory
# provided there is no '.lockfile' in the HOSTNAME directory:
NETFS_KEEP_OLD_BACKUP_COPY=yes</screen>
    <para>
     
    </para>
   </step>
   <step>
    <para>
     Prepare the backup by running:
    </para>
<screen>rear -v mkbackup</screen>
   </step>
  </procedure>

  <para>
   To perform a disaster recovery on your test machine, proceed as follows:
  </para>

  <procedure>
   <title>Perform Disaster Recovery on Test Machine</title>
   <step>
    <para>
     Locate the recovery ISO image stored as
     <filename>/var/lib/rear/output/rear-<replaceable>HOSTNAME</replaceable>.iso</filename>
     and burn it on CD.
    </para>
   </step>
   <step>
    <para>
     Boot your test machine with the recovery CD.
    </para>
   </step>
   <step>
    <para>
     Enter <command>rear</command> at the boot prompt.
    </para>
   </step>
   <step>
    <para>
     Log in as &rootuser; (no password needed).
    </para>
   </step>
   <step>
    <para>
     Enter <command>rear recover</command> to start the recovery process.
     The recovery process installs and configures the machine and retrieves
     the backup data from your NFS server.
    </para>
   </step>
  </procedure>

  <para>
   After this procedure, make sure the test machine is correctly set up and
   can serve as a replacement for your main machine. Test this procedure on
   a regular basis to ensure everything works as expected. Keep copies of
   the rescue CD ISO, in case the media is damaged.
  </para>
   
  <para>To use EMC Networker as backup tool, use the following configuration
    file:</para>
   <screen>BACKUP=NSR
OUTPUT=ISO
BACKUP_URL=nfs://dd990.&exampledomain;/data/col1/rear/backup
OUTPUT_URL=nfs://dd990.&exampledomain;/data/col1/rear/output
NSRSERVER=backupserver.&exampledomain;
RETENTION_TIME="Month"</screen>
 </sect1>
  
 <sect1 id="sec.ha.rear.config.yast2-rear">
  <title>Using the &yast; &rear; Module</title>
  <remark>toms 2014-05-14: See bnc#877276</remark>
  <!-- First appeared in SLE HA SP3, FATE#307554 -->

  <para>
   The &yast; &rear; module can be used to start with a basic setup. &rear;
   saves the recovery image and data on an NFS backend or a USB stick.
   However, the &yast; &rear; module does not support recovery from a
   disaster. This requires some expertise and has to be done manually by the
   administrator.
  </para>

  <para>
   To start with a basic setup, proceed as follows:
  </para>

  <procedure>
   <step>
    <para>
     Decide how to start your recovery system. Choose <guimenu>USB</guimenu>
     if you want to boot from a USB stick or <guimenu>ISO</guimenu> for
     CD-ROM respectively.
    </para>
   </step>
   <step>
    <para>
     Decide where the backup should be stored. Either select
     <guimenu>NFS</guimenu> or <guimenu>USB</guimenu>:
    </para>
    <itemizedlist>
     <listitem>
      <para>
       Select <guimenu>NFS</guimenu> if you have to use a server that offers
       Network File System. Specify the location as
       <filename>nfs://hostname/directory</filename>.
      </para>
     </listitem>
     <listitem>
      <para>
       Select <guimenu>USB</guimenu> if you want to store your data on a USB
       stick. If no USB devices are shown, attach a USB stick or a USB disk
       and click <guimenu>Rescan USB Devices</guimenu>.
      </para>
     </listitem>
    </itemizedlist>
   </step>
   <step>
    <para>
     If you want a previous backup copy to be saved, check <guimenu>Keep old
     backup</guimenu>.
    </para>
   </step>
   <step>
    <para>
     If you want to add additional directories that should also be included
     in your backup, use the <guimenu>Advanced</guimenu> menu and select
     <guimenu>Additional Directories in Backup</guimenu>.
    </para>
   </step>
   <step>
    <para>
     In case your rescue system does not boot due to missing Kernel modules,
     use the <guimenu>Advanced</guimenu> menu, select <guimenu>Additional
     Kernel Modules in Rescue System</guimenu>, and add the respective
     Kernel modules into the list of added modules for your rescue system.
    </para>
   </step>
   <step>
    <para>
     Click the <guimenu>Save and run rear now</guimenu> button to start the
     backup process.
    </para>
   </step>
  </procedure>

  <para>
   After the &yast; &rear; module is finished with the backup, test your
   backup to make sure it works as expected.
  </para>
 </sect1>
 <sect1 id="sec.ha.rear.more">
  <title>For More Information</title>

<!-- http://rear.github.com/documentation/ -->

  <itemizedlist>
   <listitem>
    <para>
     <ulink url="http://en.opensuse.org/SDB:Disaster_Recovery"/>
    </para>
   </listitem>
   <listitem>
    <para>
     Manpage for <command>rear</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <filename>/usr/share/doc/packages/rear/README</filename>
    </para>
   </listitem>
   <listitem>
    <para>
     <filename>/usr/share/doc/packages/rear-SUSE/README</filename>
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
