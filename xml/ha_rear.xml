<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd" [
 <!ENTITY % NOVDOC.DEACTIVATE.IDREF "INCLUDE">
 <!ENTITY % entities SYSTEM "entity-decl.ent">
 %entities;
]>
<!--Fates #310991, 312336-->
<!--taroth 2011-09-19: information sources: 
  /usr/share/doc/packages/rear/README
  /usr/share/doc/packages/rear-SUSE
  http://sourceforge.net/projects/rear/files/documentation/

-->

<chapter id="cha.ha.rear">
 <title>Disaster Recovery with &rear;</title>
  <abstract>
    <para>
      &rear; (Relax and Recover) is an administrator tool-set for creating
      disaster recovery images. The disaster recovery information can
      either be stored via the network, or locally on hard disks, USB 
      devices, DVD/CD-R, tape or similar. The backup is retrieved from
      a network file system (NFS). The result is a bootable image that 
      can be booted via PXE, or from DVD/CD, and USB media.
    </para>
    <para>Keep in mind, &rear; needs to be configured and tested
      <emphasis>before</emphasis> any disaster happens. &rear; will not
      safe you, if you disaster already took place.
    </para>
  </abstract>
  
  <sect1 id="sec.ha.rear.terminology">
    <title>Terminology</title>
    <variablelist>
      <varlistentry>
        <term>Disaster</term>
        <listitem>
          <para>Unexpected interruption of critical infrastructure induced
            by nature, humans, hardware failure, or software bugs.</para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>Disaster Recovery</term>
        <listitem>
          <para>According to &rear;'s homepage, it is <quote>the process
          by which a business function is restored to the normal, steady
          state after a disaster.</quote></para>
        </listitem>
      </varlistentry>
      <varlistentry>
        <term>Disaster Recover Plan</term>
        <listitem>
          <para>A strategy to recover from a disaster with minimum
            impact on IT infrastructure.</para>
        </listitem>
      </varlistentry>
    </variablelist>
    <!-- Some more terms needs to be added... -->
  </sect1>
  
  <sect1 id="sec.ha.rear.concept">
    <title>Conceptual Overview</title>
    <para>&sls; ships a disaster recovery system in two packages:</para>
    <itemizedlist>
      <listitem>
        <para><systemitem class="resource">rear</systemitem></para>
      </listitem>
      <listitem>
        <para><systemitem class="resource">rear-SUSE</systemitem></para>
      </listitem>
    </itemizedlist>
    
    <para>The package <systemitem
      class="resource">rear-SUSE</systemitem> is another method of a disaster
      recovery which incorporates &ay; to recreate your basic system. You should try and
     test both for your systems. Every IT infrastructure is different, in one case
     <systemitem class="resource">rear</systemitem> is enough, in other 
      situations <systemitem class="resource">rear-SUSE</systemitem> is
      a better fit. Regardless of the method, both are used in the following way:</para>
    <orderedlist>
      <listitem>
       <formalpara>
         <title>Preparation</title>
         <para>Makes a bootable CD and backups system and user data</para>
       </formalpara>
      </listitem>
      <listitem>
        <formalpara>
          <title>Testing</title>
          <para>Test the recovery process thoroughly and the backup on
            the same hardware than your main system, before any disaster happens. </para>
        </formalpara>
      </listitem>
      <listitem>
        <formalpara>
          <title>Rescue</title>
          <para>Boot from the rescue CD and restore your system from
            your backup</para>
        </formalpara>
      </listitem>
    </orderedlist>
    
    <para>To prepare the rescue media, the following details are being
      executed:</para>
    
    <orderedlist>
      <title>Preparing Rescue Media</title>
      <listitem>
        <para>Gather system information</para>
      </listitem>
      <listitem>
        <para>Store disk layout (partitioning, filesystems, LVM, RAID,
          and boot loader)</para>
      </listitem>
      <listitem>
        <para>Clone the system (Kernel drivers and modules, device
          driver configuration, network configuration, system software
          and tools)</para>
      </listitem>
      <listitem>
        <para>Backup system and user data</para>
      </listitem>
      <listitem>
        <para>Create bootable rescue CD with system configuration</para>
      </listitem>
    </orderedlist>
    
    <para>When a disaster occurered, the recovery process takes these
      actions:</para>
    
    <orderedlist>
      <title>Recovery Process</title>
      <listitem>
        <para>Boot from the rescue media</para>
      </listitem>
      <listitem>
        <para>Restore the disk layout (partitions, RAID configurations,
          LVM, file systems)</para>
      </listitem>
      <listitem>
        <para>Restore system and user data.</para>
      </listitem>
      <listitem>
        <para>Restore boot loader</para>
      </listitem>
      <listitem>
        <para>Reboot system</para>
      </listitem>
    </orderedlist>
  </sect1>
  
  <sect1 id="sec.ha.rear.drp">
    <title>Preparing for the Worst Scenarios: Disaster Recovery
      Plans</title>
    <para><emphasis>Before</emphasis> the worst scenario happens, take
      actions to avoid it with a <emphasis>disaster recovery
      plan</emphasis>. Maybe you have already some plan in place, but
      here are the general overview:</para>
    <itemizedlist>
      <listitem>
        <formalpara>
          <title>Risk Analysis</title>
          <para>Conduct a thorough risk analysis of your infrastructure.
          List all the possible threads and evaluate how serious they
          are. Determine how likely these threads are and prioritize them. It is
          recommended to use a simple categorization: probability and
          impact. </para>
        </formalpara>
        <para>For example, a company located in Japan could rate an
          earthqake as medium probability </para>
      </listitem>
      <listitem>
        <formalpara>
          <title>Budget Planing</title>
          <para>The outcome of the analysis is an
            overview, which risks can be toleralted and and which are
            critical for your business. Ask yourself, how you can 
            minimize risks and how much will it cost. Depending on how
            big your company is, spent 2 to 15 percent of the overall IT
            budget for disaster recovery.
          </para>
        </formalpara>
      </listitem>
      <listitem>
        <formalpara>
          <title>Disaster Recovery Plan Development</title>
          <para>Make checklists, test procedure, establish priorities,
            and inventory your IT infrastructure. Define how to deal
            when some services in your infrastructure fail. </para>
        </formalpara>
      </listitem>
      <listitem>
        <formalpara>
          <title>Test, Test, Test</title>
          <para>After defining an elaborate plan, test it. Test it at
            least once a year. Use the same testing hardware as your
            main IT infrastructure.</para>
        </formalpara>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 id="sec.ha.rear.config">
    <title>Setting Up &rear;</title>
    <para>To use &rear; you need at least two identical hardware: the main machine
      where all your productive environments is stored and the test
      machine. <quote>Identical</quote> in this context means, you can
      replace a network card with another one if it uses the same Kernel
      drivers. If any hardware does not uses the same driver than before
      the replacement, it is not considered as identical by &rear;.
      </para>
    <warning>
      <title>Testing is Always Needed</title>
      <para>Whenever you create a rescue CD, it is
          <emphasis>always</emphasis> needed that you test your disaster
        recovery with your test machine. Only if this works
        satiesfacotory, you disaster recover system is correctly and
        reliably set up. </para>
    </warning>
    
    <para>To create such a CD, proceed as follows:</para>
    <procedure id="pro.ha.rear.createrescue">
      <title>Creating a Rescue CD on your Main Machine</title>
      <step>
        <para>Use one of your machine which needs a rescue CD
          implemented. </para>
      </step>
      <step>
        <para>Run the following command to create the rescue CD:</para>
        <screen>rear mkbackup</screen>
      </step>
      <step>
        <para>Locate the ISO CD stored as
          <filename>/tmp/rear-<replaceable>HOSTNAME</replaceable>.iso</filename>
          and burn it on CD.
        </para>
      </step>
    </procedure>
    
    <para>To perform a disaster recovery on your test machine, proceed as follows:</para>
    
    <procedure>
      <title>Perform Disaster Recovery on Test Machine</title>
      <step>
        <para>Boot your test machine with the rescue CD from <xref
          linkend="pro.ha.rear.createrescue"/>.</para>
      </step>
      <step>
        <para>Enter <literal>rear</literal> on your boot prompt.</para>
      </step>
      <step>
        <para>Log in as &rootuser; (no password needed).</para>
      </step>
      <step>
        <para>Enter <literal>rear recover</literal> to start the
          recovery process.</para>
      </step>
    </procedure>
    
    <para>After this procedure, the test machine is correctly set up and
    can serve as your main machine, in case a disaster happens.</para>
    
  </sect1>
  
  <sect1 id="sec.ha.rear.config.ay">
    <title>Setting Up &rear; with &ay;</title>
    <para>With the package <systemitem 
      class="resource">rear-SUSE</systemitem>, the recovery process uses
      &ay;. Before you use it, check your disk space as you need at 
      least 15&nbsp;GB. This size is the sum of the ISO image
      (5&nbsp;GB), a <quote>working copy</quote> to change RPM packages
      (5&nbsp;GB), and the recover image itself (also 5&nbsp;GB).
      Depending on your situations, you can limit the overall size by 
      using an existing directory from a previous run or reduce RPM packages
      to zero bytes.</para>
    <para>The following procedure creates a <quote>full</quote> run.
      This means, it will download the ISO, creates a full backup, and
      generates the recovery images. Proceed as follows:</para>
    <procedure id="pro.ha.rear.full-recovery-image">
      <title>Creating a Full Recovery Image</title>
      <step>
        <para>Get the IP or hostname of your NFS server. If you do not
          have one, set up as described in <citetitle>Sharing File
            Systems with NFS</citetitle><!-- on <ulink url=""/>-->.</para>
      </step>
      <step>
        <para>Create a configuration file
          <filename>/etc/rear/local.conf</filename> and replace the
          <option>NETFS_URL</option> with your own values:</para>
        <screen># Create ReaR rescue media as ISO image:
OUTPUT=ISO
# Store the backup file via NFS:
BACKUP=NETFS
# Only a NETFS_URL of the form 'nfs://host/path' is supported
# so that 'mount -o nolock -t nfs host:/path' works.
NETFS_URL=nfs://&exampledomain1ip;.1/nfs/rear/
# Keep an older copy of the backup in a HOSTNAME.old directory
# provided there is no '.lockfile' in the HOSTNAME directory:
NETFS_KEEP_OLD_BACKUP_COPY=yes</screen>
        <para>If your NFS host is not an IP address but a hostname, DNS
          must work when the backup is restored.</para>
      </step>
      <step>
        <para>Prepare the backup by running:</para>
        <screen>rear mkbackuponly</screen>
      </step>
      <step>
        <para>Start the backup, and replace
          <replaceable>BACKUP</replaceable> with your backup path, and
          <replaceable>ISO</replaceable> with the path and filename of
          your ISO image:</para>
        <screen>RecoveryImage -d <replaceable>BACKUP</replaceable> \
  -l log-to-base-dir \
  -b make-rear-backup \
  -a clone-system \
  -i install-RPMs \
  -r restore-all \
  -m <replaceable>ISO</replaceable></screen>
        <para>This will start the backup process and stores your data 
          on your NFS server.</para>
      </step>
      <step id="st.ha.rear.full-recovery-image.burn">
        <para>Burn the ISO image on a CD. Find the ISO image in your
          <replaceable>BACKUP</replaceable> path with the name
          <filename>RecoverImage.<replaceable>DATE</replaceable>.iso</filename>.</para>
      </step>
    </procedure>
    
    <para>After the CD has been burnt, test your disaster recovery with
      another server. It is crucial that the hardware from your main
      server contains the same hardware in your test machine. For
      example, identical hardware is a hard disk with the same disk
      geometry, or a network card which uses the same Kernel driver.</para>
    
    <procedure>
      <title>Recovering with the Recovery Image</title>
      <step>
        <para>Boot your test machine with the recovery image from <xref
          linkend="pro.ha.rear.full-recovery-image"/> of <xref 
            linkend="st.ha.rear.full-recovery-image.burn"/>.</para>
      </step>
      <step>
        <para>Enter <literal>autorecover</literal> at the boot prompt.
          The recovery image boots and starts the &ay; installation
          process.</para>
      </step>
      <step>
        <para>Follow the instructions on the screen. Any error messages
          regarding the packages <systemitem
            class="resource">rear</systemitem> or <systemitem
            class="resource">rear-SUSE</systemitem> can be ignored.</para>
      </step>
    </procedure>
    
    <para>After the recovery there is a new, identical test machine.</para>
  </sect1>
  
  <sect1 id="sec.ha.rear.more">
    <title>For More Information</title>
    <itemizedlist>
      <listitem>
        <para><ulink url="http://rear.sourceforge.net"/></para>
      </listitem>
      <listitem>
        <para><filename>/usr/share/doc/packages/rear/README</filename></para>
      </listitem>
      <listitem>
        <para><filename>/usr/share/doc/packages/rear-SUSE/README</filename></para>
      </listitem>
    </itemizedlist>
  </sect1>
</chapter>
