<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd" [
 <!ENTITY % NOVDOC.DEACTIVATE.IDREF "INCLUDE">
 <!ENTITY % entities SYSTEM "entity-decl.ent">
 %entities;
]>
<!--Fates #310991, 312336-->
<!--taroth 2011-09-19: information sources: 
  /usr/share/doc/packages/rear/README
  /usr/share/doc/packages/rear-SUSE
  http://sourceforge.net/projects/rear/files/documentation/

-->
<chapter id="cha.ha.rear">
 <title>Disaster Recovery with &rear;</title>
 <abstract>
  <para>
   &rear; (Relax and Recover) is an administrator tool-set for creating
   disaster recovery images. The disaster recovery information can either be
   stored via the network or locally on hard disks, USB devices, DVD/CD-R,
   tape or similar. The backup data is stored on a network file system
   (NFS).
  </para>

  <para>
   Keep in mind, &rear; needs to be configured and tested
   <emphasis>before</emphasis> any disaster happens. &rear; will not save
   you, if a disaster has already taken place.
  </para>
 </abstract>
 <warning>
  <title>Extensive Testing Required</title>
  <para>
   It is essential, whenever you create a rescue CD, to
   <emphasis>always</emphasis> test the disaster recovery with an
   <emphasis>identical</emphasis> test machine. Only if this procedure works
   satisfactorily, your disaster recovery system is correctly and reliably
   set up.
  </para>
 </warning>
 <sect1 id="sec.ha.rear.terminology">
  <title>Terminology</title>

  <variablelist>
   <varlistentry>
    <term>Disaster</term>
    <listitem>
     <para>
      Unexpected interruption of critical infrastructure induced by nature,
      humans, hardware failure, or software bugs.
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Disaster Recovery</term>
    <listitem>
     <para>
      According to &rear;'s home page, disaster recovery is <quote>the
      process by which a business function is restored to the normal, steady
      state after a disaster.</quote>
     </para>
    </listitem>
   </varlistentry>
   <varlistentry>
    <term>Disaster Recover Plan</term>
    <listitem>
     <para>
      A strategy to recover from a disaster with minimum impact on IT
      infrastructure.
     </para>
    </listitem>
   </varlistentry>
  </variablelist>

<!-- Some more terms needs to be added... -->
 </sect1>
 <sect1 id="sec.ha.rear.concept">
  <title>Conceptual Overview</title>

  <para>
   &sls; ships a disaster recovery system in two packages:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     <systemitem class="resource">rear</systemitem>
    </para>
   </listitem>
   <listitem>
    <para>
     <systemitem class="resource">rear-SUSE</systemitem>
    </para>
   </listitem>
  </itemizedlist>

  <para>
   The package <systemitem
      class="resource">rear-SUSE</systemitem> is
   another method of a disaster recovery which incorporates &ay; to recreate
   your basic system. You should try and test both methods for your systems.
   Every IT infrastructure is different, in one case
   <systemitem class="resource">rear</systemitem> is enough, in other
   situations <systemitem class="resource">rear-SUSE</systemitem> is a
   better fit. Regardless of the method, both are used in the following way:
  </para>

  <orderedlist>
   <listitem>
    <formalpara>
     <title>Preparation</title>
     <para>
      Make a bootable CD and backup system and user data.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Testing</title>
     <para>
      Test the recovery process thoroughly and the backup on the same
      hardware as your main system before any disaster happens.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Recovery</title>
     <para>
      Boot from the rescue CD and restore your system from your backup.
     </para>
    </formalpara>
   </listitem>
  </orderedlist>

  <para>
   To prepare the rescue media, the following steps are performed by &rear;:
  </para>

  <orderedlist>
   <title>Preparation of Rescue Media by &rear;</title>
   <listitem>
    <para>
     Gather system information.
    </para>
   </listitem>
   <listitem>
    <para>
     Store disk layout (partitioning, filesystems, LVM, RAID, and boot
     loader).
    </para>
   </listitem>
   <listitem>
    <para>
     Clone the system (Kernel drivers and modules, device driver
     configuration, network configuration, system software and tools).
    </para>
   </listitem>
   <listitem>
    <para>
     Backup system and user data.
    </para>
   </listitem>
   <listitem>
    <para>
     Create bootable rescue CD with system configuration.
    </para>
   </listitem>
  </orderedlist>

  <remark>emap 2011-11-02: This is a bit vague. Does the admin have
      to do all this manually or is there support by &rear;? 
      I would think so, but you better make that clear.</remark>

  <remark>toms 2011-11-04: Added 'by rear' to make it clearer.</remark>

  <para>
   When a disaster occurered, the recovery process takes these actions:
  </para>

  <orderedlist>
   <title>Recovery Process</title>
   <listitem>
    <para>
     Boot from the rescue media.
    </para>
   </listitem>
   <listitem>
    <para>
     Restore the disk layout (partitions, RAID configurations, LVM, file
     systems).
    </para>
   </listitem>
   <listitem>
    <para>
     Restore system and user data.
    </para>
   </listitem>
   <listitem>
    <para>
     Restore boot loader.
    </para>
   </listitem>
   <listitem>
    <para>
     Reboot system.
    </para>
   </listitem>
  </orderedlist>
 </sect1>
 <sect1 id="sec.ha.rear.drp">
  <title>Preparing for the Worst Scenarios: Disaster Recovery Plans</title>

  <para>
   <emphasis>Before</emphasis> the worst scenario happens, take actions to
   prepare with a <emphasis>disaster recovery plan</emphasis>. A disaster
   recovery plan is a document where all risks, infrastructure, and the
   budget is being collected. Maybe you have already some plan in place, but
   here is the general overview:
  </para>

  <itemizedlist>
   <listitem>
    <formalpara>
     <title>Risk Analysis</title>
     <para>
      Conduct a solid risk analysis of your infrastructure. List all the
      possible threats and evaluate how serious they are. Determine how
      likely these threats are and prioritize them. It is recommended to use
      a simple categorization: probability and impact.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Budget Planing</title>
     <para>
      The outcome of the analysis is an overview, which risks can be
      tolerated and which are critical for your business. Ask yourself, how
      can you minimize risks and how much will it cost. Depending on how big
      your company is, spend two to fifteen percent of the overall IT budget
      on disaster recovery.
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Disaster Recovery Plan Development</title>
     <para>
      Make checklists, test procedures, establish and assign priorities, and
      inventory your IT infrastructure. Define how to deal with a problem
      when some services in your infrastructure fail.
      <remark>emap: Very vague. 
              Examples would help or a reference to a source on how 
              to create an actual DR plan. Like redundant systems, 
              failover clusters, raids, etc.</remark>
      <remark>toms 2011-11-04: Yes, that's true, but that's the task
          of the administrators. It is only there to indicate, there is
          some work to do, and not just 'relax'. :)
     </remark>
     </para>
    </formalpara>
   </listitem>
   <listitem>
    <formalpara>
     <title>Test</title>
     <para>
      After defining an elaborate plan, test it. Test it at least once a
      year. Use the same testing hardware as your main IT infrastructure.
     </para>
    </formalpara>
   </listitem>
  </itemizedlist>
 </sect1>
 <sect1 id="sec.ha.rear.config.rear">
  <title>Setting Up &rear;</title>

  <para>
   &rear; supports some backup tools (Tivoli Storage Manager, QNetix Galaxy,
   Symantec NetBackup, HP DataProtector) and can output its rescue medium to
   a CD or PXE environment. The restore step is possible through NFS or CIFS
   and other network file systems. Find more information in the &rear;
   documentation at
   <ulink url="http://rear.github.com/documentation/"></ulink>.
<!--<ulink url="http://rear.sourceforge.net/documentation.php"/>-->
  </para>

  <para>
   To use &rear; you need at least two identical systems: the main machine
   where your productive environment is stored and the test machine.
   <quote>Identical</quote> in this context means, for example, you can
   replace a network card with another one using the same Kernel driver. If
   a hardware component does not use the same driver, it is not considered
   identical by &rear;.
  </para>

  <para>
   &rear; can be used in different scenarios. The following example uses a
   NFS server as backup storage:
  </para>

  <procedure id="pro.ha.rear.nfs-server-backup">
   <title>Storing Your Backup on a NFS Server</title>
   <step>
    <para>
     Set up a NFS server with &yast; as described in <citetitle>Sharing File
     Systems with NFS</citetitle> from
     <ulink
          url="http://www.suse.com/doc/sles11/book_sle_admin/data/cha_nfs.html"/>.
    </para>
   </step>
   <step>
    <para>
     Adapt the configuration file(s). Depending on how many servers you want
     to recover, use <filename>/etc/rear/site.conf</filename> for site-wide
     settings and <filename>/etc/rear/local.conf</filename> for
     machine-local settings. The following example uses a
     <filename>/etc/rear/local.conf</filename> configuration file. Replace
     the <option>NETFS_URL</option> with your own values. Further options
     are listed in the <citetitle>Various Settings</citetitle> section of
     the documentation at
     <ulink url="http://rear.github.com/documentation/"/>.
<!--<ulink url="http://rear.sourceforge.net/documentation.php"/>-->
     <remark>taroth 2012-06-11: todo for next revision - check if the 
            cited section is still available (the project's doc page has changed to 
            http://rear.github.com/documentation/ in the meantime,
            and the page currently says: "The Rear documentation is being revised 
            and updated - Under construction"</remark>
    </para>
<screen># Create ReaR rescue media as ISO image:
OUTPUT=ISO
# Store the backup file via NFS:
BACKUP=NETFS
# Only a NETFS_URL of the form 'nfs://host/path' is supported
# so that 'mount -o nolock -t nfs host:/path' works.
NETFS_URL=nfs://&exampledomain1ip;.1/nfs/rear/
# Keep an older copy of the backup in a HOSTNAME.old directory
# provided there is no '.lockfile' in the HOSTNAME directory:
NETFS_KEEP_OLD_BACKUP_COPY=yes</screen>
    <para>
     If your NFS host is not an IP address but a hostname, DNS must work
     when the backup is restored.
    </para>
   </step>
   <step>
    <para>
     Prepare the backup by running:
    </para>
<screen>rear mkbackup</screen>
   </step>
  </procedure>

  <para>
   To perform a disaster recovery on your test machine, proceed as follows:
  </para>

  <procedure>
   <title>Perform Disaster Recovery on Test Machine</title>
   <step>
    <para>
     Locate the recovery ISO image stored as
     <filename>/tmp/rear-<replaceable>HOSTNAME</replaceable>.iso</filename>
     and burn it on CD.
    </para>
   </step>
   <step>
    <para>
     Boot your test machine with the recovery CD.
    </para>
   </step>
   <step>
    <para>
     Enter <command>rear</command> at the boot prompt.
    </para>
   </step>
   <step>
    <para>
     Log in as &rootuser; (no password needed).
    </para>
   </step>
   <step>
    <para>
     Enter <command>rear recover</command> to start the recovery process.
     The recovery process installs and configures the machine and retrieves
     the backup data from your NFS server.
    </para>
   </step>
  </procedure>

  <para>
   After this procedure, make sure the test machine is correctly set up and
   can serve as a replacement for your main machine. Test this procedure on
   a regulary basis to ensure everything works as expected. Keep copies of
   the rescue CD iso, in case the media is damaged.
  </para>
 </sect1>
 <sect1 id="sec.ha.rear.config.rear-suse">
  <title>Setting Up <systemitem class="resource">rear-SUSE</systemitem> with &ay;</title>

  <para>
   With the package
   <systemitem class="resource"
        >rear-SUSE</systemitem>, the
   recovery process uses &ay; together with a &rear; backup, which is stored
   on a NFS server. Before you use it, check your disk space, you need at
   least 5&nbsp;GB and up to 15&nbsp;GB. The size is the sum of the
   following:
  </para>

  <itemizedlist>
   <listitem>
    <para>
     The &suse; installation medium (size of 5&nbsp;GB DVD)
    </para>
   </listitem>
   <listitem>
    <para>
     A <quote>working directory</quote> copied from the &suse; installation
     medium. The working copy is used by
     <systemitem class="resource">rear-SUSE</systemitem> for preparing the
     recovery ISO image.
    </para>
   </listitem>
   <listitem>
    <para>
     Recovery ISO image. From 500&nbsp;MB up to 5&nbsp;GB.
    </para>
   </listitem>
  </itemizedlist>

  <para>
   Depending on your situation, you can limit the overall size. Refer to the
   <systemitem class="resource">rear-SUSE</systemitem> documentation for
   details in <filename>/usr/share/doc/packages/rear-SUSE/README</filename>.
  </para>

  <note>
   <title>Support of File Systems</title>
   <para>
    &ay; can only recover file systems which are supported by &yast;. Some
    file systems, like OCFS2, are currently not supported.
   </para>
  </note>

  <para>
   The following procedure creates a <quote>full</quote> recovery ISO image.
   This means, it downloads the &suse; installation medium, creates a full
   backup, and generates the recovery ISO image. Proceed as follows:
  </para>

  <procedure id="pro.ha.rear.full-recovery-image">
   <title>Creating a Full Recovery Image</title>
   <step>
    <para>
     Get the IP or hostname of your NFS server where your &rear; backup will
     be stored. If you do not have one, set up as described in
     <citetitle>Sharing File Systems with NFS</citetitle>
<!-- on <ulink url=""/>-->
     .
    </para>
   </step>
   <step>
    <para>
     Proceed with the backup as described in
     <xref
            linkend="pro.ha.rear.nfs-server-backup"/>, but use
     the command <command>rear mkbackuponly</command> to prepare the backup.
     You do not need to burn the CD.
    </para>
   </step>
   <step>
    <para>
     Start the backup, and replace <replaceable>BASE_DIR</replaceable> with
     your working directory (for example,
     <filename>/var/tmp/rear-SUSE/</filename>), and
     <replaceable>MEDIUM_URI</replaceable> (for example,
     <literal>http://server/path/medium.iso</literal>):
    </para>
<screen>RecoveryImage -c configure-all -d <replaceable>BASE_DIR</replaceable> \
  -l log-to-base-dir \
  -b make-rear-backup \
  -a clone-system \
  -i install-RPMs \
  -r restore-all \
  -m <replaceable>MEDIUM_URI</replaceable></screen>
    <para>
     This will start the backup process and store your data on your NFS
     server. After the backup process, the recovery ISO image is created.
    </para>
   </step>
   <step id="st.ha.rear.full-recovery-image.burn">
    <para>
     Burn the recovery ISO image on a DVD. Find the image in your
     <replaceable>BASE_DIR</replaceable> path with the name
     <filename>RecoverImage.<replaceable>DATE</replaceable>.iso</filename>.
    </para>
   </step>
  </procedure>

  <para>
   After the DVD has been burnt, test your disaster recovery with another
   server using the same hardware. For example, identical hardware is a hard
   disk with the same disk geometry, or a network card which uses the same
   Kernel driver.
  </para>

  <procedure>
   <title>Recovering with the Recovery Image</title>
   <step>
    <para>
     Boot your test machine with the recovery image from
     <xref
          linkend="pro.ha.rear.full-recovery-image"/> of
     <xref 
            linkend="st.ha.rear.full-recovery-image.burn"
            xrefstyle="select:nopage"/>.
    </para>
    <remark>emap: Does this make sense?</remark>
    <remark>toms 2011-11-04: Yes! :-)</remark>
   </step>
   <step>
    <para>
     Enter <literal>autorecover</literal> at the boot prompt. The recovery
     image boots and starts the &ay; installation process.
    </para>
   </step>
   <step>
    <para>
     Follow the instructions on the screen. Any error messages regarding the
     packages <systemitem
            class="resource">rear</systemitem> or
     <systemitem
            class="resource">rear-SUSE</systemitem> can be
     ignored.
    </para>
   </step>
  </procedure>

  <para>
   After the recovery, make sure the test machine functions properly and all
   data has been restored correctly from your NFS backup.
  </para>
 </sect1>
 <sect1 id="sec.ha.rear.more">
  <title>For More Information</title>

  <itemizedlist>
   <listitem>
    <para>
     <ulink url="http://rear.github.com/"/>
    </para>
   </listitem>
   <listitem>
    <para>
     Manpage for <command>rear</command>
    </para>
   </listitem>
   <listitem>
    <para>
     <filename>/usr/share/doc/packages/rear/README</filename>
    </para>
   </listitem>
   <listitem>
    <para>
     <filename>/usr/share/doc/packages/rear-SUSE/README</filename>
    </para>
   </listitem>
  </itemizedlist>
 </sect1>
</chapter>
