<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd" [
 <!ENTITY % NOVDOC.DEACTIVATE.IDREF "INCLUDE">
 <!ENTITY % entities SYSTEM "entity-decl.ent">
 %entities;
]>
<chapter id="cha.ha.installation.yast">
 <title>Installation and Basic Setup with &yast;</title>
 <abstract>
  <para>
   There are several ways to install the software needed for &ha; clusters:
   either from a command line, using <command>zypper</command>, or with
   &yast; which provides a graphical user interface. After installing the
   software on all nodes that will be part of your cluster, the next step is
   to initially configure the cluster so that the nodes can communicate with
   each other. This can either be done manually (by editing a configuration
   file) or with the &yast; cluster module.
  </para>
 </abstract>
 <note>
  <title>Installing the Software Packages</title>
  <para>
   The software packages needed for &ha; clusters are not automatically
   copied to the cluster nodes. Install &slsreg; &productnumber; and
   &productnamereg; &productnumber; on all nodes that will be part of your
   cluster.
  </para>
 </note>
 <sect1 id="sec.ha.installation.inst">
  <title>Installing the &hasi;</title>

  <para>
   The packages needed for configuring and managing a cluster with the
   &hasi; are included in the <literal>High Availability</literal>
   installation pattern. This patterns is only available after
   &productnamereg; has been installed as add-on.
   <remark>taroth 090115: need to use
    hard-coded link here as the target is not included in the same set</remark>
   For information on how to install add-on products, refer to the &sle;
   &productnumber; &deploy;, chapter
   <citetitle>Installing Add-On Products</citetitle>.
  </para>

  <procedure>
   <step>
    <para>
     Start &yast; and select <menuchoice> <guimenu>Software</guimenu>
     <guimenu>Software Management</guimenu> </menuchoice> to open the &yast;
     package manager.
    </para>
   </step>
   <step>
    <para>
     From the <guimenu>Filter</guimenu> list, select
     <guimenu>Patterns</guimenu> and activate the <guimenu>High
     Availability</guimenu> pattern in the pattern list.
    </para>
   </step>
   <step>
    <para>
     Click <guimenu>Accept</guimenu> to start the installation of the
     packages.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 id="sec.ha.installation.setup">
  <title>Initial Cluster Setup</title>

  <para>
   After having installed the HA packages, you can configure the initial
   cluster setup with &yast;. This includes the communication channels
   between the nodes, security aspects (like using encrypted communication)
   and starting &ais; as service.
  </para>

  <para>
   For the communication channels, you need to define a bind network address
   (<literal>bindnetaddr</literal>), a multicast address
   (<literal>mcastaddr</literal>) and a multicast port
   (<literal>mcastport</literal>). The <literal>bindnetaddr</literal> is the
   network address to bind to. To ease sharing configuration files across
   the cluster, &ais; uses network interface netmask to mask only the
   address bits that are used for routing the network. The
   <literal>mcastaddr</literal> can be a IPv4 or IPv6 multicast address. The
   <literal>mcastport</literal> is the UDP port specified for
   <literal>mcastaddr</literal>.
  </para>

  <para>
   The nodes in the cluster will know each other from using the same
   multicast address and the same port number. For different clusters, use a
   different multicast address.
<!--(Setting up two or more
   clusters that use the same multicast address, but a different port, also works, 
    but is less efficient).-->
  </para>

  <procedure>
   <title>Configuring the Cluster</title>
   <step>
    <para>
     Start &yast; and select <menuchoice> <guimenu>Miscellaneous</guimenu>
     <guimenu>Cluster</guimenu> </menuchoice> or run <command>yast2
     cluster</command> on a command line to start the initial cluster
     configuration dialog.
    </para>
   </step>
   <step>
    <para>
     In the <guimenu>Communication Channel</guimenu> category, configure the
     channels used for communication between the cluster nodes. This
     information is written to the
     <filename>/etc/ais/openais.conf</filename> configuration file.
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_cluster_communication.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_cluster_communication.png" width="75%" format="png"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
    <para>
     Define the <guimenu>Bind Network Address</guimenu>, the
     <guimenu>Multicast Address</guimenu> and the <guimenu>Multicast
     Port</guimenu> to use for all cluster nodes.
    </para>
   </step>
   <step>
    <para>
     Specify a unique <guimenu>Node ID</guimenu> for every cluster node. It
     is recommended to start at <literal>1</literal>.
    </para>
   </step>
   <step>
    <para>
     In the <guimenu>Security</guimenu> category, define the authentication
     settings for the cluster. If <guimenu>Enable Security
     Authentication</guimenu> is activated, HMAC/SHA1 authentication is used
     for communication between the cluster nodes.
    </para>
    <para>
     This authentication method requires a shared secret, which is used to
     protect and authenticate messages. The authentication key (password)
     you specify will be used on all nodes in the cluster. For a newly
     created cluster, click <guimenu>Generate Auth Key File</guimenu> to
     create an authentication key that is written to
     <filename>/etc/ais/authkey</filename>.
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_cluster_security.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_cluster_security.png" width="75%" format="png"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
   </step>
   <step>
    <para>
     In the <guimenu>Service</guimenu> category, choose whether you want to
     start &ais; on this cluster server each time it is booted.
    </para>
    <informalfigure>
     <mediaobject>
      <imageobject role="fo">
       <imagedata fileref="yast2_cluster_service.png" width="75%" format="PNG"/>
      </imageobject>
      <imageobject role="html">
       <imagedata fileref="yast2_cluster_service.png" width="75%" format="png"/>
      </imageobject>
     </mediaobject>
    </informalfigure>
    <para>
     If you select <guimenu>Off</guimenu>, you must start &ais; manually
     each time this cluster server is booted. To start &ais; manually, use
     the <command>rcopenais start</command> command.
    </para>
    <para>
     To start &ais; immediately, click <guimenu>Start &ais; Now</guimenu>.
    </para>
   </step>
   <step>
    <para>
     If all options are set according to your wishes, click
     <guimenu>Finish</guimenu>. &yast; then automatically also adjusts the
     firewall settings and opens the UDP port used for multicast.
    </para>
   </step>
   <step>
    <para>
     After the initial configuration is done, you need to transfer the
     configuration to the other nodes in the cluster. The easiest way to do
     so is to copy the <filename>/etc/ais/openais.conf</filename> file to
     the other nodes in the cluster. As each node needs to have a unique
     node ID, make sure to adjust the node ID accordingly after copying the
     file.
    </para>
   </step>
   <step>
    <para>
     If you want to use encrypted communication, also copy the
     <filename>/etc/ais/authkey</filename> to the other nodes in the
     cluster.
    </para>
   </step>
  </procedure>
 </sect1>
 <sect1 id="sec.ha.installation.start">
  <title>Bringing the Cluster Online</title>

  <para>
   After the basic configuration, you can bring the stack online and check
   the status.
  </para>

  <procedure>
   <step>
    <para>
     Run the following command on each of the cluster nodes to start &ais;:
    </para>
<screen>rcopenais start</screen>
   </step>
   <step>
    <para>
     On one of the nodes, check the cluster status with the following
     command:
    </para>
<screen>crm_mon</screen>
    <para>
     If all nodes are online, the output should be similar to the following:
    </para>
<screen>============
Last updated: Thu Feb  5 18:30:33 2009
Current DC: d42 (d42)
Version: 1.0.1-node: b7ffe2729e3003ac8ff740bebc003cf237dfa854
3 Nodes configured.
0 Resources configured.
============
     
Node: d230 (d230): online
Node: d42 (d42): online
Node: e246 (e246): online</screen>
   </step>
  </procedure>

  <para>
   After the basic configuration is done and the nodes are online, you can
   now start to configure cluster resources, either with the
   <command>crm</command> command line tool or with a graphical user
   interface. For more information, refer to
   <xref linkend="cha.ha.configuration.gui"
   /> or
   <xref linkend="cha.ha.manual_config"/>.
  </para>
 </sect1>
</chapter>
