<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//Novell//DTD NovDoc XML V1.0//EN" "novdocx.dtd" [
 <!ENTITY % NOVDOC.DEACTIVATE.IDREF "INCLUDE">
 <!ENTITY % entities SYSTEM "entity-decl.ent">
 %entities;
]>

<!-- 
 bnc#633212

-->

<chapter id="cha.ha.acl">
  <title>Access Control Lists for Cluster Resources</title>
  <abstract>
    <para> Administrating clusters with the various tools like the crm
      shell, &hawk;, or the Python GUI can only be used by &rootuser; or
      any user who are part of the <systemitem class="groupname"
        >hacluster</systemitem> group. In some cases this may be not
        enough.</para>
    <para>With <emphasis>access control lists</emphasis> (ACLs) you can
      define rules to allow or deny access to a resource.
      Typically, rules are combined to create specific roles and users
      may be assigned a role to make access .</para>
  </abstract>
  
  <sect1 id="sec.ha.acl.require">
    <title>Requirements and Prerequisites</title>
    <para>Before you start using ACLs on your cluster, make sure the
      following conditions are fullfilled:</para>
    <itemizedlist>
      <listitem>
        <para>The same users must be available on all nodes in your
          cluster. Use NIS to ensure this.</para>
      </listitem>
      <listitem>
        <para>All users must belong to the <systemitem class="groupname"
          >hacluster</systemitem> group.</para>
      </listitem>
    </itemizedlist>
    
    <para>Furthermore, configure your cluster as follows:</para>
    <procedure>
      <step>
        <para>Configure the CIB to use the Pacemaker 1.1 or 1.2 schema:</para>
        <screen>cibadmin --modify --xml-text '&lt;cib validate-with="pacemaker-1.1"/>'</screen>
      </step>
      <step>
        <para>Set the <option>enable-acl</option> option:</para>
        <screen>crm configure property enable-acl=true</screen>
      </step>
    </procedure>
    
    <para>Note the following issues:</para>
    <itemizedlist>
      <listitem>
        <para>User &rootuser; and users belonging to the <systemitem 
          class="groupname">hacluster</systemitem> group has always full
        access.</para>
      </listitem>
      <listitem>
        <para>Non-privileged users want to run the crm shell, they have
          to  change the <envar>PATH</envar> variable and extend it with
          <filename>/usr/sbin</filename>.
        </para>
      </listitem>
      <listitem>
        <para>In order to use (advanced) ACLs you need minimum knowledge about
          XPath. XPath is a language for retrieving nodes in a XML
          document. Refer to <link
            linkend="http://en.wikipedia.org/wiki/XPath"/> or look into
          the specification at <link
            linkend="http://www.w3.org/TR/xpath/"/>.</para>
      </listitem>
    </itemizedlist>
  </sect1>
  
  <sect1 id="sec.ha.acl.basics">
    <title>Knowing the Basics of ACLs</title>
    <para>An ACL role is a set of rules which describe access rights to
      CIB. Rules consists of these parts: </para>
    <itemizedlist>
      <listitem>
        <para>Access rights to read, write, or deny,</para>
      </listitem>
      <listitem>
        <para>An XPath expression where to apply this rule.</para>
      </listitem>
    </itemizedlist>
    
    <para>In order to use ACLs you need to know the structure of the
      underlying XML. This can be retrieved by using the following
      command:</para>
    <screen>crm configure show xml</screen>
    <remark>toms 2011-11-03: What about the Python GUI? Hawk?
      Couldn't find it.</remark>
    <para>The output is a XML structure of your cluster configuration
      (see <xref linkend="ex.ha.acl.excerpt"/>). </para>
    <example id="ex.ha.acl.excerpt">
      <title>Excerpt of a Cluster Configuration in XML</title>
    <screen><![CDATA[<cib admin_epoch="0" 
      cib-last-written="Wed Nov  2 16:42:51 2011" 
      crm_feature_set="3.0.5" 
      dc-uuid="stuttgart" 
      epoch="13" have-quorum="1" num_updates="42" 
      update-client="cibadmin" 
      update-origin="nuernberg" 
      update-user="root"validate-with="pacemaker-1.2">
  <configuration>
    <crm_config>
      <cluster_property_set id="cib-bootstrap-options">
        <nvpair id="cib-bootstrap-options-stonith-enabled" 
                name="stonith-enabled" value="true"/>
      </cluster_property_set>
    </crm_config>
    <nodes>
      <node id="stuttgart" type="normal" uname="stuttgart"/>
      <node id="nuernberg" type="normal" uname="nuernberg"/>
    </nodes>
    <resources> ...  </resources>
    <constraints/>
    <rsc_defaults> ... </rsc_defaults>
    <op_defaults> ... </op_defaults>
  <configuration>
</cib>]]></screen>
    </example>
    <para>With the XPath language you can locate nodes in this XML
      document. For example, to retrieve the root node
      (<literal>cib</literal>) use the XPath expression
      <literal>/cib</literal>. To locate the global cluster 
      configurations, use the XPath
      <literal>/cib/configuration/crm_config</literal>. </para>
    <para>Using ACLs is specifying a role and assigning a role to a
      user.
    </para>
  </sect1>
  
  <sect1 id="sec.ha.acl.config.pygui">
      <title>Configuring with the Pacemaker GUI</title>
      <para></para>
  </sect1>
  <sect1 id="sec.ha.acl.config.crm">
      <title>Configuring with the crm Shell</title>
      <para>To use ACLs, use the crm shell and define your roles and
      users there.</para>
    
    <sect2>
      <title>Defining Roles</title>
      <para>Use the <command>role</command> command to get an
        overview of the syntax:</para>
    <screen>$ crm configure
crm(live)configure# role</screen>
      <para>To permit read-only access to the entire CIB, for example,
        use the following command:</para>
    <screen>crm(live)configure# role monitor read xpath:"/cib"</screen>
    <para></para>
    </sect2>
    
    <sect2>
      <title>Assigning Roles to Users</title>
      <para>This is really simple: After you have definied your role,
        use the <command>user</command> command to assign this role to
        a user:</para>
      <screen>crm(live)configure# user &exampleuser; role:monitor
crm(live)configure# user &exampleuserII; role:operator</screen>
    </sect2>
  </sect1>
  
  <sect1 id="sec.ha.acl.moreinfo">
    <title>For More Information</title>
    <para>See <ulink url="http://www.clusterlabs.org/doc/acls.html"/>.</para>
  </sect1>
</chapter>
